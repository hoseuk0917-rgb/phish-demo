   13: type UrlKind = "official" | "typo" | "homoglyph" | "short";
   14: type Anchor =
   15:     | "A_LINK"
   16:     | "A_QR"
   17:     | "A_OTP"
   18:     | "A_INSTALL"
   19:     | "A_TRANSFER"
   20:     | "A_GO_BANK"
   21:     | "A_CASH_PICKUP"
   22:     | "A_TRAVEL"
   23:     | "A_CRED"
   24:     | "A_PII";
   25: 
   26: type Risk = "low" | "medium" | "high";
   27: type Stage = "info" | "verify" | "install" | "payment";
   28: 
   29: type ScenarioTurn = { role: "S" | "R"; text: string };
   30: 
   31: type ScenarioInternal = {
   32:     id: string;
   33:     caseType: CaseType;
   34:     channel: Channel;
   35:     caller: {
   36:         caller_id: string;
   37:         caller_display: string; // DEMO 가상 표기
   38:         caller_class: CallerClass;
   39:         is_whitelisted: boolean;
   40:         is_first_seen: boolean;
   41:     };
   42:     vector: Vector;
   43:     url?: { kind: UrlKind; value: string; count: 0 | 1; match?: boolean; official_id?: string };
   44:     qr?: { target_kind: UrlKind; note: string; match?: boolean; official_id?: string };
   45:     anchors: Anchor[];
   46:     pressures: string[]; // press_*
   47:     impersonation?: string; // imp_*
   48:     turns: ScenarioTurn[];
   49:     expected: {
   50:         risk: Risk;
   51:         stagePeak: Stage;
   52:         triggers: string[];
   53:     };
   54:     meta?: AnyObj;
   55: };
   56: 
   57: type CaseType =
   58:     | "delivery_link"
   59:     | "fine_refund_link"
   60:     | "bank_otp"
   61:     | "bank_install"
   62:     | "account_takeover_cred"
   63:     | "pii_collection"
   64:     | "family_urgent_transfer"
   65:     | "loan_fee"
   66:     | "go_bank_atm"
   67:     | "cash_pickup"
   68:     | "job_travel"
   69:     | "blackmail_sexvisit";
   70: 
   71: type Args = {
   72:     stubs: string;
   73:     out: string;
   74:     count: number;
   75:     seed: number;
   76:     benign_ratio: number; // 0..1
   77:     hardneg_ratio: number; // 0..1 (benign 내부 비중)
   78:     max_len: number; // 1..20
   79:     max_retries: number;
   80:     registry_out?: string;
   81: 
   82:     // ✅ 추가: direct(기본) | meta(시연용 완곡문)
   83:     anchor_style?: AnchorStyle;
   84: };
   85: 
   86: type AnchorStyle = "direct" | "meta";
   87: let ANCHOR_STYLE: AnchorStyle = "direct";
   88: 
   89: function parseArgs(argv: string[]): Args {
   90:     const a: AnyObj = {};
   91:     for (let i = 0; i < argv.length; i++) {
   92:         const k = argv[i];
   93:         if (!k.startsWith("--")) continue;
   94:         const key = k.slice(2).replace(/-/g, "_");
   95:         const v = argv[i + 1];
   96:         if (v && !v.startsWith("--")) {
   97:             a[key] = v;
   98:             i++;
   99:         } else {
  100:             a[key] = true;
  101:         }
  102:     }
  103: 
  104:     const isHelp = argv.includes("--help") || argv.includes("-h") || a.help === true;
  105:     if (isHelp) {
  106:         console.log(
  107:             [
  108:                 "Usage:",
  109:                 "  npx tsx tools/analysis/genScenariosFromStubs.ts --stubs <path> --out <path> [--count N] [--seed N] ...",
  110:                 "",
  111:                 "Options:",
  112:                 "  --stubs <path>         input stubs jsonl",
  113:                 "  --out <path>           output scenarios jsonl",
   37:         caller_display: string; // DEMO 가상 표기
   38:         caller_class: CallerClass;
   39:         is_whitelisted: boolean;
   40:         is_first_seen: boolean;
   41:     };
   42:     vector: Vector;
   43:     url?: { kind: UrlKind; value: string; count: 0 | 1; match?: boolean; official_id?: string };
   44:     qr?: { target_kind: UrlKind; note: string; match?: boolean; official_id?: string };
   45:     anchors: Anchor[];
   46:     pressures: string[]; // press_*
   47:     impersonation?: string; // imp_*
   48:     turns: ScenarioTurn[];
   49:     expected: {
   50:         risk: Risk;
   51:         stagePeak: Stage;
   52:         triggers: string[];
   53:     };
   54:     meta?: AnyObj;
   55: };
   56: 
   57: type CaseType =
   58:     | "delivery_link"
   59:     | "fine_refund_link"
   60:     | "bank_otp"
   61:     | "bank_install"
   62:     | "account_takeover_cred"
   63:     | "pii_collection"
   64:     | "family_urgent_transfer"
   65:     | "loan_fee"
   66:     | "go_bank_atm"
   67:     | "cash_pickup"
   68:     | "job_travel"
   69:     | "blackmail_sexvisit";
   70: 
   71: type Args = {
   72:     stubs: string;
   73:     out: string;
   74:     count: number;
   75:     seed: number;
   76:     benign_ratio: number; // 0..1
   77:     hardneg_ratio: number; // 0..1 (benign 내부 비중)
   78:     max_len: number; // 1..20
   79:     max_retries: number;
   80:     registry_out?: string;
   81: 
   82:     // ✅ 추가: direct(기본) | meta(시연용 완곡문)
   83:     anchor_style?: AnchorStyle;
   84: };
   85: 
   86: type AnchorStyle = "direct" | "meta";
   87: let ANCHOR_STYLE: AnchorStyle = "direct";
   88: 
   89: function parseArgs(argv: string[]): Args {
   90:     const a: AnyObj = {};
   91:     for (let i = 0; i < argv.length; i++) {
   92:         const k = argv[i];
   93:         if (!k.startsWith("--")) continue;
   94:         const key = k.slice(2).replace(/-/g, "_");
   95:         const v = argv[i + 1];
   96:         if (v && !v.startsWith("--")) {
   97:             a[key] = v;
   98:             i++;
   99:         } else {
  100:             a[key] = true;
  101:         }
  102:     }
  103: 
  104:     const isHelp = argv.includes("--help") || argv.includes("-h") || a.help === true;
  105:     if (isHelp) {
  106:         console.log(
  107:             [
  108:                 "Usage:",
  109:                 "  npx tsx tools/analysis/genScenariosFromStubs.ts --stubs <path> --out <path> [--count N] [--seed N] ...",
  110:                 "",
  111:                 "Options:",
  112:                 "  --stubs <path>         input stubs jsonl",
  113:                 "  --out <path>           output scenarios jsonl",
  114:                 "  --count <n>            default 500",
  115:                 "  --seed <n>             default 42",
  116:                 "  --benign-ratio <0..1>  default 0.25",
  117:                 "  --hardneg-ratio <0..1> default 0.6",
  118:                 "  --max-len <1..20>      default 20",
  119:                 "  --max-retries <n>      default 12",
  120:                 "  --registry-out <path>  optional (debug)",
  121:                 "  --anchor-style <direct|meta> default direct",
  122:                 "",
  123:                 "Example:",
  124:                 "  npx tsx tools/analysis/genScenariosFromStubs.ts --stubs datasets/ko_scam/scenario_stubs_from_clusters_merged_patched.jsonl --out datasets/ko_scam/scenarios_ko_v3.jsonl --count 500 --seed 42",
  125:             ].join("\n")
  126:         );
  127:         process.exit(0);
  128:     }
  129: 
  130:     const stubs = String(a.stubs || "");
  131:     const out = String(a.out || "");
  132:     if (!stubs || !out) {
  133:         throw new Error("Usage: --stubs <path> --out <path> [--count N] [--seed N] ... (try --help)");
  134:     }
  135: 
  136:     const rawAnchorStyle = String(
  137:         (a as any).anchor_style ?? (a as any)["anchor-style"] ?? (a as any).anchorStyle ?? "direct"
   44:     qr?: { target_kind: UrlKind; note: string; match?: boolean; official_id?: string };
   45:     anchors: Anchor[];
   46:     pressures: string[]; // press_*
   47:     impersonation?: string; // imp_*
   48:     turns: ScenarioTurn[];
   49:     expected: {
   50:         risk: Risk;
   51:         stagePeak: Stage;
   52:         triggers: string[];
   53:     };
   54:     meta?: AnyObj;
   55: };
   56: 
   57: type CaseType =
   58:     | "delivery_link"
   59:     | "fine_refund_link"
   60:     | "bank_otp"
   61:     | "bank_install"
   62:     | "account_takeover_cred"
   63:     | "pii_collection"
   64:     | "family_urgent_transfer"
   65:     | "loan_fee"
   66:     | "go_bank_atm"
   67:     | "cash_pickup"
   68:     | "job_travel"
   69:     | "blackmail_sexvisit";
   70: 
   71: type Args = {
   72:     stubs: string;
   73:     out: string;
   74:     count: number;
   75:     seed: number;
   76:     benign_ratio: number; // 0..1
   77:     hardneg_ratio: number; // 0..1 (benign 내부 비중)
   78:     max_len: number; // 1..20
   79:     max_retries: number;
   80:     registry_out?: string;
   81: 
   82:     // ✅ 추가: direct(기본) | meta(시연용 완곡문)
   83:     anchor_style?: AnchorStyle;
   84: };
   85: 
   86: type AnchorStyle = "direct" | "meta";
   87: let ANCHOR_STYLE: AnchorStyle = "direct";
   88: 
   89: function parseArgs(argv: string[]): Args {
   90:     const a: AnyObj = {};
   91:     for (let i = 0; i < argv.length; i++) {
   92:         const k = argv[i];
   93:         if (!k.startsWith("--")) continue;
   94:         const key = k.slice(2).replace(/-/g, "_");
   95:         const v = argv[i + 1];
   96:         if (v && !v.startsWith("--")) {
   97:             a[key] = v;
   98:             i++;
   99:         } else {
  100:             a[key] = true;
  101:         }
  102:     }
  103: 
  104:     const isHelp = argv.includes("--help") || argv.includes("-h") || a.help === true;
  105:     if (isHelp) {
  106:         console.log(
  107:             [
  108:                 "Usage:",
  109:                 "  npx tsx tools/analysis/genScenariosFromStubs.ts --stubs <path> --out <path> [--count N] [--seed N] ...",
  110:                 "",
  111:                 "Options:",
  112:                 "  --stubs <path>         input stubs jsonl",
  113:                 "  --out <path>           output scenarios jsonl",
  114:                 "  --count <n>            default 500",
  115:                 "  --seed <n>             default 42",
  116:                 "  --benign-ratio <0..1>  default 0.25",
  117:                 "  --hardneg-ratio <0..1> default 0.6",
  118:                 "  --max-len <1..20>      default 20",
  119:                 "  --max-retries <n>      default 12",
  120:                 "  --registry-out <path>  optional (debug)",
  121:                 "  --anchor-style <direct|meta> default direct",
  122:                 "",
  123:                 "Example:",
  124:                 "  npx tsx tools/analysis/genScenariosFromStubs.ts --stubs datasets/ko_scam/scenario_stubs_from_clusters_merged_patched.jsonl --out datasets/ko_scam/scenarios_ko_v3.jsonl --count 500 --seed 42",
  125:             ].join("\n")
  126:         );
  127:         process.exit(0);
  128:     }
  129: 
  130:     const stubs = String(a.stubs || "");
  131:     const out = String(a.out || "");
  132:     if (!stubs || !out) {
  133:         throw new Error("Usage: --stubs <path> --out <path> [--count N] [--seed N] ... (try --help)");
  134:     }
  135: 
  136:     const rawAnchorStyle = String(
  137:         (a as any).anchor_style ?? (a as any)["anchor-style"] ?? (a as any).anchorStyle ?? "direct"
  138:     ).toLowerCase();
  139: 
  140:     return {
  141:         stubs,
  142:         out,
  143:         count: clampInt(parseInt(String(a.count || "500"), 10), 1, 200000),
  144:         seed: clampInt(parseInt(String(a.seed || "42"), 10), 1, 2_000_000_000),
  283:     let out = "";
  284:     for (let i = 0; i < n; i++) out += String(Math.floor(rng() * 10));
  285:     return out;
  286: }
  287: function make010(rng: () => number) {
  288:     return `010-${randDigits(rng, 4)}-${randDigits(rng, 4)}`;
  289: }
  290: function make070(rng: () => number) {
  291:     return `070-${randDigits(rng, 4)}-${randDigits(rng, 4)}`;
  292: }
  293: function normalizeCallerDisplay(
  294:     rng: () => number,
  295:     c: CallerRegistryEntry,
  296: ): CallerRegistryEntry {
  297:     if (c.caller_class === "mobile") return { ...c, caller_display: make010(rng) };
  298:     if (c.caller_class === "voip070") return { ...c, caller_display: make070(rng) };
  299:     if (c.caller_class === "unknown") return { ...c, caller_display: `발신번호표시제한(${make010(rng)})` };
  300:     return c; // official_landline 등은 그대로
  301: }
  302: 
  303: function chooseCaller(rng: () => number, caseType: CaseType, isBenign: boolean): ScenarioInternal["caller"] {
  304:     const reg = buildCallerRegistry();
  305: 
  306:     const spoofedOfficial = (caller_id: string): ScenarioInternal["caller"] => {
  307:         const found = reg.find((x) => x.caller_id === caller_id) || reg[0];
  308:         return {
  309:             caller_id: found.caller_id,
  310:             caller_display: found.caller_display,
  311:             caller_class: "spoofed",
  312:             is_whitelisted: true,
  313:             is_first_seen: false,
  314:         };
  315:     };
  316: 
  317:     if (isBenign) {
  318:         const c0 = pick(rng, reg.filter((x) => x.is_whitelisted));
  319:         const c = normalizeCallerDisplay(rng, c0);
  320:         return { ...c, is_first_seen: false };
  321:     }
  322: 
  323:     if (caseType.startsWith("bank_") || caseType === "account_takeover_cred") {
  324:         if (chance(rng, 0.25)) return spoofedOfficial("OFFICIAL_BANK_MAIN");
  325:         const pool0 = reg.filter((x) => !x.is_whitelisted && (x.caller_class === "voip070" || x.caller_class === "mobile" || x.caller_class === "unknown"));
  326:         const c = normalizeCallerDisplay(rng, pick(rng, pool0));
  327:         return { ...c, is_first_seen: true };
  328:     }
  329: 
  330:     if (caseType === "go_bank_atm") {
  331:         if (chance(rng, 0.3)) return spoofedOfficial("OFFICIAL_COURT_MAIN");
  332:         const pool0 = reg.filter((x) => !x.is_whitelisted);
  333:         const c = normalizeCallerDisplay(rng, pick(rng, pool0));
  334:         return { ...c, is_first_seen: true };
  335:     }
  336: 
  337:     const pool0 = reg.filter((x) => !x.is_whitelisted);
  338:     const c = normalizeCallerDisplay(rng, pick(rng, pool0));
  339:     return { ...c, is_first_seen: true };
  340: }
  341: 
  342: // ---------- URL/QR (DEMO: 가상 "공식 URL 레지스트리" 기반) ----------
  343: type UrlOwner = "bank" | "card" | "court" | "police" | "prosecutor" | "gov" | "delivery";
  344: 
  345: type UrlRegistryEntry = {
  346:     url_id: string;
  347:     owner: UrlOwner;
  348:     url: string;
  349:     host: string;
  350:     label: string;
  351: };
  352: 
  353: function buildUrlRegistry(): UrlRegistryEntry[] {
  354:     return [
  355:         { url_id: "OFFICIAL_BANK_LOGIN", owner: "bank", url: "https://portal-bank.invalid/secure/login", host: "portal-bank.invalid", label: "은행 포털 로그인" },
  356:         { url_id: "OFFICIAL_BANK_VERIFY", owner: "bank", url: "https://portal-bank.invalid/secure/verify", host: "portal-bank.invalid", label: "은행 보안 확인" },
  357:         { url_id: "OFFICIAL_CARD_AUTH", owner: "card", url: "https://card-center.invalid/auth/confirm", host: "card-center.invalid", label: "카드 본인확인" },
  358: 
  359:         { url_id: "OFFICIAL_COURT_NOTICE", owner: "court", url: "https://court-notice.invalid/case/view", host: "court-notice.invalid", label: "법원 사건 조회" },
  360:         { url_id: "OFFICIAL_POLICE_HELP", owner: "police", url: "https://police-help.invalid/verify", host: "police-help.invalid", label: "경찰 확인 안내" },
  361:         { url_id: "OFFICIAL_PROSECUTOR_HELP", owner: "prosecutor", url: "https://prosecutor-help.invalid/verify", host: "prosecutor-help.invalid", label: "검찰 확인 안내" },
  362:         { url_id: "OFFICIAL_GOV_PAY", owner: "gov", url: "https://tax-refund.invalid/pay/check", host: "tax-refund.invalid", label: "납부/환급 확인" },
  363: 
  364:         { url_id: "OFFICIAL_DELIVERY_ADDR", owner: "delivery", url: "https://track-parcel.invalid/addr/confirm", host: "track-parcel.invalid", label: "배송지 확인" },
  365:         { url_id: "OFFICIAL_DELIVERY_PICKUP", owner: "delivery", url: "https://track-parcel.invalid/pickup/check", host: "track-parcel.invalid", label: "보관/수령 확인" },
  366:     ];
  367: }
  368: 
  369: function ownersFromImpersonation(imp?: string): UrlOwner[] {
  370:     switch (imp) {
  371:         case "imp_bank": return ["bank", "card"];
  372:         case "imp_court": return ["court"];
  373:         case "imp_police": return ["police"];
  374:         case "imp_gov": return ["gov"];
  375:         case "imp_delivery": return ["delivery"];
  376:         default: return ["bank", "card", "court", "police", "gov", "delivery"];
  377:     }
  378: }
  379: 
  380: function pickOfficialUrlEntry(rng: () => number, ownerChoices: UrlOwner[]): UrlRegistryEntry {
  381:     const reg = buildUrlRegistry().filter(r => ownerChoices.includes(r.owner));
  382:     return pick(rng, reg.length ? reg : buildUrlRegistry());
  383: }
  303: function chooseCaller(rng: () => number, caseType: CaseType, isBenign: boolean): ScenarioInternal["caller"] {
  304:     const reg = buildCallerRegistry();
  305: 
  306:     const spoofedOfficial = (caller_id: string): ScenarioInternal["caller"] => {
  307:         const found = reg.find((x) => x.caller_id === caller_id) || reg[0];
  308:         return {
  309:             caller_id: found.caller_id,
  310:             caller_display: found.caller_display,
  311:             caller_class: "spoofed",
  312:             is_whitelisted: true,
  313:             is_first_seen: false,
  314:         };
  315:     };
  316: 
  317:     if (isBenign) {
  318:         const c0 = pick(rng, reg.filter((x) => x.is_whitelisted));
  319:         const c = normalizeCallerDisplay(rng, c0);
  320:         return { ...c, is_first_seen: false };
  321:     }
  322: 
  323:     if (caseType.startsWith("bank_") || caseType === "account_takeover_cred") {
  324:         if (chance(rng, 0.25)) return spoofedOfficial("OFFICIAL_BANK_MAIN");
  325:         const pool0 = reg.filter((x) => !x.is_whitelisted && (x.caller_class === "voip070" || x.caller_class === "mobile" || x.caller_class === "unknown"));
  326:         const c = normalizeCallerDisplay(rng, pick(rng, pool0));
  327:         return { ...c, is_first_seen: true };
  328:     }
  329: 
  330:     if (caseType === "go_bank_atm") {
  331:         if (chance(rng, 0.3)) return spoofedOfficial("OFFICIAL_COURT_MAIN");
  332:         const pool0 = reg.filter((x) => !x.is_whitelisted);
  333:         const c = normalizeCallerDisplay(rng, pick(rng, pool0));
  334:         return { ...c, is_first_seen: true };
  335:     }
  336: 
  337:     const pool0 = reg.filter((x) => !x.is_whitelisted);
  338:     const c = normalizeCallerDisplay(rng, pick(rng, pool0));
  339:     return { ...c, is_first_seen: true };
  340: }
  341: 
  342: // ---------- URL/QR (DEMO: 가상 "공식 URL 레지스트리" 기반) ----------
  343: type UrlOwner = "bank" | "card" | "court" | "police" | "prosecutor" | "gov" | "delivery";
  344: 
  345: type UrlRegistryEntry = {
  346:     url_id: string;
  347:     owner: UrlOwner;
  348:     url: string;
  349:     host: string;
  350:     label: string;
  351: };
  352: 
  353: function buildUrlRegistry(): UrlRegistryEntry[] {
  354:     return [
  355:         { url_id: "OFFICIAL_BANK_LOGIN", owner: "bank", url: "https://portal-bank.invalid/secure/login", host: "portal-bank.invalid", label: "은행 포털 로그인" },
  356:         { url_id: "OFFICIAL_BANK_VERIFY", owner: "bank", url: "https://portal-bank.invalid/secure/verify", host: "portal-bank.invalid", label: "은행 보안 확인" },
  357:         { url_id: "OFFICIAL_CARD_AUTH", owner: "card", url: "https://card-center.invalid/auth/confirm", host: "card-center.invalid", label: "카드 본인확인" },
  358: 
  359:         { url_id: "OFFICIAL_COURT_NOTICE", owner: "court", url: "https://court-notice.invalid/case/view", host: "court-notice.invalid", label: "법원 사건 조회" },
  360:         { url_id: "OFFICIAL_POLICE_HELP", owner: "police", url: "https://police-help.invalid/verify", host: "police-help.invalid", label: "경찰 확인 안내" },
  361:         { url_id: "OFFICIAL_PROSECUTOR_HELP", owner: "prosecutor", url: "https://prosecutor-help.invalid/verify", host: "prosecutor-help.invalid", label: "검찰 확인 안내" },
  362:         { url_id: "OFFICIAL_GOV_PAY", owner: "gov", url: "https://tax-refund.invalid/pay/check", host: "tax-refund.invalid", label: "납부/환급 확인" },
  363: 
  364:         { url_id: "OFFICIAL_DELIVERY_ADDR", owner: "delivery", url: "https://track-parcel.invalid/addr/confirm", host: "track-parcel.invalid", label: "배송지 확인" },
  365:         { url_id: "OFFICIAL_DELIVERY_PICKUP", owner: "delivery", url: "https://track-parcel.invalid/pickup/check", host: "track-parcel.invalid", label: "보관/수령 확인" },
  366:     ];
  367: }
  368: 
  369: function ownersFromImpersonation(imp?: string): UrlOwner[] {
  370:     switch (imp) {
  371:         case "imp_bank": return ["bank", "card"];
  372:         case "imp_court": return ["court"];
  373:         case "imp_police": return ["police"];
  374:         case "imp_gov": return ["gov"];
  375:         case "imp_delivery": return ["delivery"];
  376:         default: return ["bank", "card", "court", "police", "gov", "delivery"];
  377:     }
  378: }
  379: 
  380: function pickOfficialUrlEntry(rng: () => number, ownerChoices: UrlOwner[]): UrlRegistryEntry {
  381:     const reg = buildUrlRegistry().filter(r => ownerChoices.includes(r.owner));
  382:     return pick(rng, reg.length ? reg : buildUrlRegistry());
  383: }
  384: 
  385: function typoHost(host: string, rng: () => number) {
  386:     if (host.length < 8) return host;
  387:     const mode = pick(rng, ["swap", "drop", "dup"] as const);
  388:     const i = Math.floor(rng() * (host.length - 3)) + 1;
  389:     if (mode === "swap") return host.slice(0, i) + host[i + 1] + host[i] + host.slice(i + 2);
  390:     if (mode === "drop") return host.slice(0, i) + host.slice(i + 1);
  391:     return host.slice(0, i) + host[i] + host.slice(i);
  392: }
  393: 
  394: function homoglyphLiteHost(host: string, rng: () => number) {
  395:     const rules: Array<[RegExp, string]> = [
  396:         [/o/g, "0"],
  397:         [/l/g, "1"],
  398:         [/rn/g, "m"],
  399:         [/vv/g, "w"],
  400:     ];
  401:     const [re, rep] = pick(rng, rules);
  402:     if (!re.test(host)) return typoHost(host, rng);
  403:     return host.replace(re, rep);
  310:             caller_display: found.caller_display,
  311:             caller_class: "spoofed",
  312:             is_whitelisted: true,
  313:             is_first_seen: false,
  314:         };
  315:     };
  316: 
  317:     if (isBenign) {
  318:         const c0 = pick(rng, reg.filter((x) => x.is_whitelisted));
  319:         const c = normalizeCallerDisplay(rng, c0);
  320:         return { ...c, is_first_seen: false };
  321:     }
  322: 
  323:     if (caseType.startsWith("bank_") || caseType === "account_takeover_cred") {
  324:         if (chance(rng, 0.25)) return spoofedOfficial("OFFICIAL_BANK_MAIN");
  325:         const pool0 = reg.filter((x) => !x.is_whitelisted && (x.caller_class === "voip070" || x.caller_class === "mobile" || x.caller_class === "unknown"));
  326:         const c = normalizeCallerDisplay(rng, pick(rng, pool0));
  327:         return { ...c, is_first_seen: true };
  328:     }
  329: 
  330:     if (caseType === "go_bank_atm") {
  331:         if (chance(rng, 0.3)) return spoofedOfficial("OFFICIAL_COURT_MAIN");
  332:         const pool0 = reg.filter((x) => !x.is_whitelisted);
  333:         const c = normalizeCallerDisplay(rng, pick(rng, pool0));
  334:         return { ...c, is_first_seen: true };
  335:     }
  336: 
  337:     const pool0 = reg.filter((x) => !x.is_whitelisted);
  338:     const c = normalizeCallerDisplay(rng, pick(rng, pool0));
  339:     return { ...c, is_first_seen: true };
  340: }
  341: 
  342: // ---------- URL/QR (DEMO: 가상 "공식 URL 레지스트리" 기반) ----------
  343: type UrlOwner = "bank" | "card" | "court" | "police" | "prosecutor" | "gov" | "delivery";
  344: 
  345: type UrlRegistryEntry = {
  346:     url_id: string;
  347:     owner: UrlOwner;
  348:     url: string;
  349:     host: string;
  350:     label: string;
  351: };
  352: 
  353: function buildUrlRegistry(): UrlRegistryEntry[] {
  354:     return [
  355:         { url_id: "OFFICIAL_BANK_LOGIN", owner: "bank", url: "https://portal-bank.invalid/secure/login", host: "portal-bank.invalid", label: "은행 포털 로그인" },
  356:         { url_id: "OFFICIAL_BANK_VERIFY", owner: "bank", url: "https://portal-bank.invalid/secure/verify", host: "portal-bank.invalid", label: "은행 보안 확인" },
  357:         { url_id: "OFFICIAL_CARD_AUTH", owner: "card", url: "https://card-center.invalid/auth/confirm", host: "card-center.invalid", label: "카드 본인확인" },
  358: 
  359:         { url_id: "OFFICIAL_COURT_NOTICE", owner: "court", url: "https://court-notice.invalid/case/view", host: "court-notice.invalid", label: "법원 사건 조회" },
  360:         { url_id: "OFFICIAL_POLICE_HELP", owner: "police", url: "https://police-help.invalid/verify", host: "police-help.invalid", label: "경찰 확인 안내" },
  361:         { url_id: "OFFICIAL_PROSECUTOR_HELP", owner: "prosecutor", url: "https://prosecutor-help.invalid/verify", host: "prosecutor-help.invalid", label: "검찰 확인 안내" },
  362:         { url_id: "OFFICIAL_GOV_PAY", owner: "gov", url: "https://tax-refund.invalid/pay/check", host: "tax-refund.invalid", label: "납부/환급 확인" },
  363: 
  364:         { url_id: "OFFICIAL_DELIVERY_ADDR", owner: "delivery", url: "https://track-parcel.invalid/addr/confirm", host: "track-parcel.invalid", label: "배송지 확인" },
  365:         { url_id: "OFFICIAL_DELIVERY_PICKUP", owner: "delivery", url: "https://track-parcel.invalid/pickup/check", host: "track-parcel.invalid", label: "보관/수령 확인" },
  366:     ];
  367: }
  368: 
  369: function ownersFromImpersonation(imp?: string): UrlOwner[] {
  370:     switch (imp) {
  371:         case "imp_bank": return ["bank", "card"];
  372:         case "imp_court": return ["court"];
  373:         case "imp_police": return ["police"];
  374:         case "imp_gov": return ["gov"];
  375:         case "imp_delivery": return ["delivery"];
  376:         default: return ["bank", "card", "court", "police", "gov", "delivery"];
  377:     }
  378: }
  379: 
  380: function pickOfficialUrlEntry(rng: () => number, ownerChoices: UrlOwner[]): UrlRegistryEntry {
  381:     const reg = buildUrlRegistry().filter(r => ownerChoices.includes(r.owner));
  382:     return pick(rng, reg.length ? reg : buildUrlRegistry());
  383: }
  384: 
  385: function typoHost(host: string, rng: () => number) {
  386:     if (host.length < 8) return host;
  387:     const mode = pick(rng, ["swap", "drop", "dup"] as const);
  388:     const i = Math.floor(rng() * (host.length - 3)) + 1;
  389:     if (mode === "swap") return host.slice(0, i) + host[i + 1] + host[i] + host.slice(i + 2);
  390:     if (mode === "drop") return host.slice(0, i) + host.slice(i + 1);
  391:     return host.slice(0, i) + host[i] + host.slice(i);
  392: }
  393: 
  394: function homoglyphLiteHost(host: string, rng: () => number) {
  395:     const rules: Array<[RegExp, string]> = [
  396:         [/o/g, "0"],
  397:         [/l/g, "1"],
  398:         [/rn/g, "m"],
  399:         [/vv/g, "w"],
  400:     ];
  401:     const [re, rep] = pick(rng, rules);
  402:     if (!re.test(host)) return typoHost(host, rng);
  403:     return host.replace(re, rep);
  404: }
  405: 
  406: function makeVariantUrlFromOfficial(rng: () => number, official: UrlRegistryEntry, kind: UrlKind): string {
  407:     if (kind === "official") return official.url;
  408: 
  409:     if (kind === "short") {
  410:         const code = Math.floor(rng() * 90000 + 10000).toString(36).slice(0, 5);
  448:     const p = level === "low" ? 0.12 : level === "mid" ? 0.2 : 0.32;
  449:     let out = s;
  450: 
  451:     if (chance(rng, p)) out = out.replace(/해주세요/g, chance(rng, 0.5) ? "해 주세요" : "해주세 요");
  452:     if (chance(rng, p * 0.8)) out = out.replace(/바로/g, chance(rng, 0.5) ? "바 로" : "바로 ");
  453: 
  454:     if (chance(rng, p)) out = out.replace(/입니다\./g, chance(rng, 0.5) ? "입니다요." : "입니다.");
  455:     if (chance(rng, p)) out = out.replace(/하세요\./g, chance(rng, 0.5) ? "하세여." : "하세요.");
  456: 
  457:     if (chance(rng, p * 0.7)) out = out.replace(/확인/g, chance(rng, 0.5) ? "확닌" : "확잉");
  458:     if (chance(rng, p * 0.6)) out = out.replace(/입금/g, chance(rng, 0.5) ? "입금요" : "입끔");
  459: 
  460:     return out;
  461: }
  462: 
  463: function varyEnding(rng: () => number, base: string, tone: KoTone): string {
  464:     // base는 “~합니다.” 형태를 권장. tone에 따라 가볍게 변환.
  465:     if (!base.endsWith(".")) base = base + ".";
  466:     if (tone === "formal") return base;
  467: 
  468:     const variantsPolite: Array<(s: string) => string> = [
  469:         (s) => s.replace(/합니다\./g, "해 주세요."),
  470:         (s) => s.replace(/합니다\./g, "부탁드립니다."),
  471:         (s) => s.replace(/필요합니다\./g, "필요해요."),
  472:         (s) => s.replace(/입니다\./g, "이에요."),
  473:     ];
  474:     const variantsCasual: Array<(s: string) => string> = [
  475:         (s) => s.replace(/합니다\./g, "해요."),
  476:         (s) => s.replace(/필요합니다\./g, "필요해요."),
  477:         (s) => s.replace(/입니다\./g, "임."),
  478:         (s) => s.replace(/부탁드립니다\./g, "부탁해요."),
  479:     ];
  480: 
  481:     const fns = tone === "polite" ? variantsPolite : variantsCasual;
  482:     return pick(rng, fns)(base);
  483: }
  484: 
  485: function pickSyn(rng: () => number, xs: string[]) {
  486:     return pick(rng, xs);
  487: }
  488: 
  489: function renderAnchorLineSafe(
  490:     rng: () => number,
  491:     a: Anchor,
  492:     tone: KoTone,
  493:     urlStr?: string,
  494:     vector?: Vector,
  495:     urlKind?: UrlKind,
  496: ): string {
  497:     const hasUrl = (s: string) => /https?:\/\/\S+/i.test(s);
  498: 
  499:     const addUrlHint = (s: string) => {
  500:         if ((vector === "url" || vector === "qr") && (a === "A_LINK" || a === "A_QR") && urlKind) {
  501:             if (urlKind === "short") s += ` (단축주소 short)`;
  502:             if (urlKind === "typo") s += ` (오타/유사문자 typo)`;
  503:             if (urlKind === "homoglyph") s += ` (유사치환 homoglyph)`;
  504:         }
  505:         if (hasUrl(s)) return s; // URL 포함 문장은 '.' 안 붙임
  506:         return s.endsWith(".") ? s : s + ".";
  507:     };
  508: 
  509:     const dummyBank = () => pick(rng, ["OO은행", "OO저축은행", "OO카드"] as const);
  510:     const dummyName = () => pick(rng, ["홍길동", "김민수", "이서연", "박지훈"] as const);
  511:     const dummyAcct = () => {
  512:         const a = Math.floor(rng() * 900 + 100);
  513:         const b = Math.floor(rng() * 90 + 10);
  514:         const c = Math.floor(rng() * 900000 + 100000);
  515:         return `${a}-${b}-${c}`;
  516:     };
  517: 
  518:     if (ANCHOR_STYLE === "meta") {
  519:         let base = "";
  520:         if (a === "A_LINK") base = `링크 확인 유도가 포함됩니다: ${urlStr || "https://example.invalid/"}`;
  521:         if (a === "A_QR") base = `QR 스캔 유도가 포함됩니다(랜딩): ${urlStr || "https://example.invalid/"}`;
  522:         if (a === "A_OTP") base = `OTP(인증번호) 공유/전달을 요구하는 내용이 포함됩니다`;
  523:         if (a === "A_INSTALL") base = `원격지원/지원앱 설치 유도가 포함됩니다 (remote / AnyDesk / TeamViewer)`;
  524:         if (a === "A_TRANSFER")
  525:             base = `송금/이체 유도가 포함됩니다: ${dummyBank()} 계좌번호 ${dummyAcct()} (예금주:${dummyName()})로 입금/송금(remit/wire)`;
  526:         if (a === "A_GO_BANK") base = `은행/ATM 방문 및 현금 인출(withdraw/cash) 유도가 포함됩니다 (ATM)`;
  527:         if (a === "A_CASH_PICKUP") base = `현금/퀵/대면 전달(cash pickup) 유도가 포함됩니다`;
  528:         if (a === "A_TRAVEL") base = `이동/출국 유도가 포함됩니다`;
  529:         if (a === "A_CRED") base = `로그인 정보 입력 유도가 포함됩니다${urlStr && vector === "url" ? `: ${urlStr}` : ""}`;
  530:         if (a === "A_PII") base = `개인정보 제공 유도가 포함됩니다${urlStr && vector === "url" ? `: ${urlStr}` : ""}`;
  531:         return varyEnding(rng, addUrlHint(base), tone);
  532:     }
  533: 
  534:     let out = "";
  535:     if (a === "A_LINK") out = `아래 링크 확인해 주세요: ${urlStr || "https://example.invalid/"}`;
  536:     if (a === "A_QR") out = `QR 찍고 접속해 주세요: ${urlStr || "https://example.invalid/"}`;
  537: 
  538:     // ✅ "번호 주세요"는 demand(알려/입력/전달) 정규식에 안 걸릴 수 있어, 엔진/라벨 정합을 위해 표현을 고정
  539:     if (a === "A_OTP") out = `OTP(인증번호) 알려주세요`;
  540: 
  541:     if (a === "A_INSTALL") out = `원격지원 앱(TeamViewer/AnyDesk) 설치해 주세요 (remote)`;
  542:     if (a === "A_TRANSFER")
  543:         out = `${dummyBank()} 계좌번호 ${dummyAcct()} (예금주:${dummyName()})로 지금 입금/송금(remit/wire)해 주세요`;
  544:     if (a === "A_GO_BANK") out = `지금 ATM으로 가서 현금 인출(withdraw/cash) 후 연락해 주세요 (ATM)`;
  545:     if (a === "A_CASH_PICKUP") out = `현금 봉투 준비해서 퀵/대면(cash pickup)으로 전달해 주세요`;
  546:     if (a === "A_TRAVEL") out = `출국 가능하시면 공항 쪽으로 이동해 주세요`;
  547:     if (a === "A_CRED") out = `아이디/비밀번호 입력해 주세요${urlStr && vector === "url" ? `: ${urlStr}` : ""}`;
  548:     if (a === "A_PII") out = `개인정보(신분증/계좌) 보내 주세요${urlStr && vector === "url" ? `: ${urlStr}` : ""}`;
  454:     if (chance(rng, p)) out = out.replace(/입니다\./g, chance(rng, 0.5) ? "입니다요." : "입니다.");
  455:     if (chance(rng, p)) out = out.replace(/하세요\./g, chance(rng, 0.5) ? "하세여." : "하세요.");
  456: 
  457:     if (chance(rng, p * 0.7)) out = out.replace(/확인/g, chance(rng, 0.5) ? "확닌" : "확잉");
  458:     if (chance(rng, p * 0.6)) out = out.replace(/입금/g, chance(rng, 0.5) ? "입금요" : "입끔");
  459: 
  460:     return out;
  461: }
  462: 
  463: function varyEnding(rng: () => number, base: string, tone: KoTone): string {
  464:     // base는 “~합니다.” 형태를 권장. tone에 따라 가볍게 변환.
  465:     if (!base.endsWith(".")) base = base + ".";
  466:     if (tone === "formal") return base;
  467: 
  468:     const variantsPolite: Array<(s: string) => string> = [
  469:         (s) => s.replace(/합니다\./g, "해 주세요."),
  470:         (s) => s.replace(/합니다\./g, "부탁드립니다."),
  471:         (s) => s.replace(/필요합니다\./g, "필요해요."),
  472:         (s) => s.replace(/입니다\./g, "이에요."),
  473:     ];
  474:     const variantsCasual: Array<(s: string) => string> = [
  475:         (s) => s.replace(/합니다\./g, "해요."),
  476:         (s) => s.replace(/필요합니다\./g, "필요해요."),
  477:         (s) => s.replace(/입니다\./g, "임."),
  478:         (s) => s.replace(/부탁드립니다\./g, "부탁해요."),
  479:     ];
  480: 
  481:     const fns = tone === "polite" ? variantsPolite : variantsCasual;
  482:     return pick(rng, fns)(base);
  483: }
  484: 
  485: function pickSyn(rng: () => number, xs: string[]) {
  486:     return pick(rng, xs);
  487: }
  488: 
  489: function renderAnchorLineSafe(
  490:     rng: () => number,
  491:     a: Anchor,
  492:     tone: KoTone,
  493:     urlStr?: string,
  494:     vector?: Vector,
  495:     urlKind?: UrlKind,
  496: ): string {
  497:     const hasUrl = (s: string) => /https?:\/\/\S+/i.test(s);
  498: 
  499:     const addUrlHint = (s: string) => {
  500:         if ((vector === "url" || vector === "qr") && (a === "A_LINK" || a === "A_QR") && urlKind) {
  501:             if (urlKind === "short") s += ` (단축주소 short)`;
  502:             if (urlKind === "typo") s += ` (오타/유사문자 typo)`;
  503:             if (urlKind === "homoglyph") s += ` (유사치환 homoglyph)`;
  504:         }
  505:         if (hasUrl(s)) return s; // URL 포함 문장은 '.' 안 붙임
  506:         return s.endsWith(".") ? s : s + ".";
  507:     };
  508: 
  509:     const dummyBank = () => pick(rng, ["OO은행", "OO저축은행", "OO카드"] as const);
  510:     const dummyName = () => pick(rng, ["홍길동", "김민수", "이서연", "박지훈"] as const);
  511:     const dummyAcct = () => {
  512:         const a = Math.floor(rng() * 900 + 100);
  513:         const b = Math.floor(rng() * 90 + 10);
  514:         const c = Math.floor(rng() * 900000 + 100000);
  515:         return `${a}-${b}-${c}`;
  516:     };
  517: 
  518:     if (ANCHOR_STYLE === "meta") {
  519:         let base = "";
  520:         if (a === "A_LINK") base = `링크 확인 유도가 포함됩니다: ${urlStr || "https://example.invalid/"}`;
  521:         if (a === "A_QR") base = `QR 스캔 유도가 포함됩니다(랜딩): ${urlStr || "https://example.invalid/"}`;
  522:         if (a === "A_OTP") base = `OTP(인증번호) 공유/전달을 요구하는 내용이 포함됩니다`;
  523:         if (a === "A_INSTALL") base = `원격지원/지원앱 설치 유도가 포함됩니다 (remote / AnyDesk / TeamViewer)`;
  524:         if (a === "A_TRANSFER")
  525:             base = `송금/이체 유도가 포함됩니다: ${dummyBank()} 계좌번호 ${dummyAcct()} (예금주:${dummyName()})로 입금/송금(remit/wire)`;
  526:         if (a === "A_GO_BANK") base = `은행/ATM 방문 및 현금 인출(withdraw/cash) 유도가 포함됩니다 (ATM)`;
  527:         if (a === "A_CASH_PICKUP") base = `현금/퀵/대면 전달(cash pickup) 유도가 포함됩니다`;
  528:         if (a === "A_TRAVEL") base = `이동/출국 유도가 포함됩니다`;
  529:         if (a === "A_CRED") base = `로그인 정보 입력 유도가 포함됩니다${urlStr && vector === "url" ? `: ${urlStr}` : ""}`;
  530:         if (a === "A_PII") base = `개인정보 제공 유도가 포함됩니다${urlStr && vector === "url" ? `: ${urlStr}` : ""}`;
  531:         return varyEnding(rng, addUrlHint(base), tone);
  532:     }
  533: 
  534:     let out = "";
  535:     if (a === "A_LINK") out = `아래 링크 확인해 주세요: ${urlStr || "https://example.invalid/"}`;
  536:     if (a === "A_QR") out = `QR 찍고 접속해 주세요: ${urlStr || "https://example.invalid/"}`;
  537: 
  538:     // ✅ "번호 주세요"는 demand(알려/입력/전달) 정규식에 안 걸릴 수 있어, 엔진/라벨 정합을 위해 표현을 고정
  539:     if (a === "A_OTP") out = `OTP(인증번호) 알려주세요`;
  540: 
  541:     if (a === "A_INSTALL") out = `원격지원 앱(TeamViewer/AnyDesk) 설치해 주세요 (remote)`;
  542:     if (a === "A_TRANSFER")
  543:         out = `${dummyBank()} 계좌번호 ${dummyAcct()} (예금주:${dummyName()})로 지금 입금/송금(remit/wire)해 주세요`;
  544:     if (a === "A_GO_BANK") out = `지금 ATM으로 가서 현금 인출(withdraw/cash) 후 연락해 주세요 (ATM)`;
  545:     if (a === "A_CASH_PICKUP") out = `현금 봉투 준비해서 퀵/대면(cash pickup)으로 전달해 주세요`;
  546:     if (a === "A_TRAVEL") out = `출국 가능하시면 공항 쪽으로 이동해 주세요`;
  547:     if (a === "A_CRED") out = `아이디/비밀번호 입력해 주세요${urlStr && vector === "url" ? `: ${urlStr}` : ""}`;
  548:     if (a === "A_PII") out = `개인정보(신분증/계좌) 보내 주세요${urlStr && vector === "url" ? `: ${urlStr}` : ""}`;
  549: 
  550:     return addUrlHint(out);
  551: }
  552: 
  553: // ---------- 스텁 기반 “핵심수법/유도방식” 추출(비중용이 아니라 생성 파라미터/문구 선택용) ----------
  554: type StubFeatures = {
  461: }
  462: 
  463: function varyEnding(rng: () => number, base: string, tone: KoTone): string {
  464:     // base는 “~합니다.” 형태를 권장. tone에 따라 가볍게 변환.
  465:     if (!base.endsWith(".")) base = base + ".";
  466:     if (tone === "formal") return base;
  467: 
  468:     const variantsPolite: Array<(s: string) => string> = [
  469:         (s) => s.replace(/합니다\./g, "해 주세요."),
  470:         (s) => s.replace(/합니다\./g, "부탁드립니다."),
  471:         (s) => s.replace(/필요합니다\./g, "필요해요."),
  472:         (s) => s.replace(/입니다\./g, "이에요."),
  473:     ];
  474:     const variantsCasual: Array<(s: string) => string> = [
  475:         (s) => s.replace(/합니다\./g, "해요."),
  476:         (s) => s.replace(/필요합니다\./g, "필요해요."),
  477:         (s) => s.replace(/입니다\./g, "임."),
  478:         (s) => s.replace(/부탁드립니다\./g, "부탁해요."),
  479:     ];
  480: 
  481:     const fns = tone === "polite" ? variantsPolite : variantsCasual;
  482:     return pick(rng, fns)(base);
  483: }
  484: 
  485: function pickSyn(rng: () => number, xs: string[]) {
  486:     return pick(rng, xs);
  487: }
  488: 
  489: function renderAnchorLineSafe(
  490:     rng: () => number,
  491:     a: Anchor,
  492:     tone: KoTone,
  493:     urlStr?: string,
  494:     vector?: Vector,
  495:     urlKind?: UrlKind,
  496: ): string {
  497:     const hasUrl = (s: string) => /https?:\/\/\S+/i.test(s);
  498: 
  499:     const addUrlHint = (s: string) => {
  500:         if ((vector === "url" || vector === "qr") && (a === "A_LINK" || a === "A_QR") && urlKind) {
  501:             if (urlKind === "short") s += ` (단축주소 short)`;
  502:             if (urlKind === "typo") s += ` (오타/유사문자 typo)`;
  503:             if (urlKind === "homoglyph") s += ` (유사치환 homoglyph)`;
  504:         }
  505:         if (hasUrl(s)) return s; // URL 포함 문장은 '.' 안 붙임
  506:         return s.endsWith(".") ? s : s + ".";
  507:     };
  508: 
  509:     const dummyBank = () => pick(rng, ["OO은행", "OO저축은행", "OO카드"] as const);
  510:     const dummyName = () => pick(rng, ["홍길동", "김민수", "이서연", "박지훈"] as const);
  511:     const dummyAcct = () => {
  512:         const a = Math.floor(rng() * 900 + 100);
  513:         const b = Math.floor(rng() * 90 + 10);
  514:         const c = Math.floor(rng() * 900000 + 100000);
  515:         return `${a}-${b}-${c}`;
  516:     };
  517: 
  518:     if (ANCHOR_STYLE === "meta") {
  519:         let base = "";
  520:         if (a === "A_LINK") base = `링크 확인 유도가 포함됩니다: ${urlStr || "https://example.invalid/"}`;
  521:         if (a === "A_QR") base = `QR 스캔 유도가 포함됩니다(랜딩): ${urlStr || "https://example.invalid/"}`;
  522:         if (a === "A_OTP") base = `OTP(인증번호) 공유/전달을 요구하는 내용이 포함됩니다`;
  523:         if (a === "A_INSTALL") base = `원격지원/지원앱 설치 유도가 포함됩니다 (remote / AnyDesk / TeamViewer)`;
  524:         if (a === "A_TRANSFER")
  525:             base = `송금/이체 유도가 포함됩니다: ${dummyBank()} 계좌번호 ${dummyAcct()} (예금주:${dummyName()})로 입금/송금(remit/wire)`;
  526:         if (a === "A_GO_BANK") base = `은행/ATM 방문 및 현금 인출(withdraw/cash) 유도가 포함됩니다 (ATM)`;
  527:         if (a === "A_CASH_PICKUP") base = `현금/퀵/대면 전달(cash pickup) 유도가 포함됩니다`;
  528:         if (a === "A_TRAVEL") base = `이동/출국 유도가 포함됩니다`;
  529:         if (a === "A_CRED") base = `로그인 정보 입력 유도가 포함됩니다${urlStr && vector === "url" ? `: ${urlStr}` : ""}`;
  530:         if (a === "A_PII") base = `개인정보 제공 유도가 포함됩니다${urlStr && vector === "url" ? `: ${urlStr}` : ""}`;
  531:         return varyEnding(rng, addUrlHint(base), tone);
  532:     }
  533: 
  534:     let out = "";
  535:     if (a === "A_LINK") out = `아래 링크 확인해 주세요: ${urlStr || "https://example.invalid/"}`;
  536:     if (a === "A_QR") out = `QR 찍고 접속해 주세요: ${urlStr || "https://example.invalid/"}`;
  537: 
  538:     // ✅ "번호 주세요"는 demand(알려/입력/전달) 정규식에 안 걸릴 수 있어, 엔진/라벨 정합을 위해 표현을 고정
  539:     if (a === "A_OTP") out = `OTP(인증번호) 알려주세요`;
  540: 
  541:     if (a === "A_INSTALL") out = `원격지원 앱(TeamViewer/AnyDesk) 설치해 주세요 (remote)`;
  542:     if (a === "A_TRANSFER")
  543:         out = `${dummyBank()} 계좌번호 ${dummyAcct()} (예금주:${dummyName()})로 지금 입금/송금(remit/wire)해 주세요`;
  544:     if (a === "A_GO_BANK") out = `지금 ATM으로 가서 현금 인출(withdraw/cash) 후 연락해 주세요 (ATM)`;
  545:     if (a === "A_CASH_PICKUP") out = `현금 봉투 준비해서 퀵/대면(cash pickup)으로 전달해 주세요`;
  546:     if (a === "A_TRAVEL") out = `출국 가능하시면 공항 쪽으로 이동해 주세요`;
  547:     if (a === "A_CRED") out = `아이디/비밀번호 입력해 주세요${urlStr && vector === "url" ? `: ${urlStr}` : ""}`;
  548:     if (a === "A_PII") out = `개인정보(신분증/계좌) 보내 주세요${urlStr && vector === "url" ? `: ${urlStr}` : ""}`;
  549: 
  550:     return addUrlHint(out);
  551: }
  552: 
  553: // ---------- 스텁 기반 “핵심수법/유도방식” 추출(비중용이 아니라 생성 파라미터/문구 선택용) ----------
  554: type StubFeatures = {
  555:     hasOtp: boolean;
  556:     hasRemote: boolean;
  557:     hasTransfer: boolean;
  558:     hasCash: boolean;
  559:     hasTravel: boolean;
  560:     hasBlackmail: boolean;
  561:     hasPII: boolean;
  605:     if (f.hasQr) out.push("qr");
  606:     if (f.hasGoBank) out.push("go_bank");   // ✅ 추가
  607:     if (f.mentionsTypo) out.push("typo");
  608:     if (f.mentionsShort) out.push("short");
  609:     return out;
  610: }
  611: 
  612: function chooseUrlKindFromFeatures(rng: () => number, f: StubFeatures): UrlKind {
  613:     if (f.mentionsShort) return "short";
  614:     if (f.mentionsTypo) return chance(rng, 0.6) ? "typo" : "homoglyph";
  615: 
  616:     // ✅ 악성은 '공식' 비중을 낮추고 typo/homoglyph/short 중심으로
  617:     const r = rng();
  618:     if (r < 0.20) return "official";
  619:     if (r < 0.55) return "typo";
  620:     if (r < 0.80) return "homoglyph";
  621:     return "short";
  622: }
  623: 
  624: // ---------- 케이스 타입 결정(스텁 기반) ----------
  625: function inferCaseTypeFromStub(rng: () => number, stub: AnyObj): CaseType {
  626:     const text = `${stub.title || ""} ${stub.subject || ""} ${Array.isArray(stub.context_blocks) ? stub.context_blocks.join(" ") : ""} ${stub.body || ""}`
  627:         .toLowerCase()
  628:         .slice(0, 4000);
  629: 
  630:     const has = (re: RegExp) => re.test(text);
  631: 
  632:     if (has(/유흥|유포|협박|영상|폭로|불륜|성매매|업소/)) return "blackmail_sexvisit";
  633:     if (has(/출국|항공|비행기|여권|현지|취업|동남아|캄보|라오|태국/)) return "job_travel";
  634:     if (has(/택배|배송|운송장|부재|보관/)) return "delivery_link";
  635:     if (has(/과태료|범칙금|미납|납부|환급/)) return "fine_refund_link";
  636:     if (has(/원격|앱설치|설치|팀뷰|애니데|anydesk|지원앱/)) return "bank_install";
  637:     if (has(/인증번호|otp|보안코드/)) return "bank_otp";
  638:     if (has(/비밀번호|로그인|계정|인증\s*실패|잠금/)) return "account_takeover_cred";
  639:     if (has(/주민|계좌|카드번호|신분증|개인정보/)) return "pii_collection";
  640:     if (has(/대출|수수료|보증금|선입금/)) return "loan_fee";
  641:     if (has(/atm|현금인출|은행으로|창구/)) return "go_bank_atm";
  642:     if (has(/퀵|봉투|현금|직접\s*전달|대면/)) return "cash_pickup";
  643: 
  644:     const pool: CaseType[] = [
  645:         "delivery_link",
  646:         "fine_refund_link",
  647:         "bank_otp",
  648:         "bank_install",
  649:         "account_takeover_cred",
  650:         "pii_collection",
  651:         "family_urgent_transfer",
  652:         "loan_fee",
  653:         "go_bank_atm",
  654:         "cash_pickup",
  655:         "job_travel",
  656:         "blackmail_sexvisit",
  657:     ];
  658:     return pick(rng, pool);
  659: }
  660: 
  661: // ---------- 케이스별 설정 ----------
  662: function requiredAnchors(caseType: CaseType): Anchor[] {
  663:     switch (caseType) {
  664:         case "delivery_link":
  665:         case "fine_refund_link":
  666:             return ["A_LINK"];
  667:         case "bank_otp":
  668:             return ["A_OTP"];
  669:         case "bank_install":
  670:             return ["A_INSTALL"];
  671:         case "account_takeover_cred":
  672:             return ["A_CRED"];
  673:         case "pii_collection":
  674:             return ["A_PII"];
  675:         case "family_urgent_transfer":
  676:             return ["A_TRANSFER"];
  677:         case "loan_fee":
  678:             return ["A_TRANSFER"];
  679:         case "go_bank_atm":
  680:             return ["A_GO_BANK"];
  681:         case "cash_pickup":
  682:             return ["A_CASH_PICKUP"];
  683:         case "job_travel":
  684:             return ["A_TRAVEL"];
  685:         case "blackmail_sexvisit":
  686:             return ["A_TRANSFER"];
  687:         default:
  688:             return ["A_TRANSFER"];
  689:     }
  690: }
  691: 
  692: function defaultVectorFor(caseType: CaseType): Vector {
  693:     switch (caseType) {
  694:         case "delivery_link":
  695:         case "fine_refund_link":
  696:         case "account_takeover_cred":
  697:         case "pii_collection":
  698:             return "url";
  699:         default:
  700:             return "none";
  701:     }
  702: }
  703: 
  704: function impersonationFor(caseType: CaseType): string | undefined {
  705:     switch (caseType) {
  624: // ---------- 케이스 타입 결정(스텁 기반) ----------
  625: function inferCaseTypeFromStub(rng: () => number, stub: AnyObj): CaseType {
  626:     const text = `${stub.title || ""} ${stub.subject || ""} ${Array.isArray(stub.context_blocks) ? stub.context_blocks.join(" ") : ""} ${stub.body || ""}`
  627:         .toLowerCase()
  628:         .slice(0, 4000);
  629: 
  630:     const has = (re: RegExp) => re.test(text);
  631: 
  632:     if (has(/유흥|유포|협박|영상|폭로|불륜|성매매|업소/)) return "blackmail_sexvisit";
  633:     if (has(/출국|항공|비행기|여권|현지|취업|동남아|캄보|라오|태국/)) return "job_travel";
  634:     if (has(/택배|배송|운송장|부재|보관/)) return "delivery_link";
  635:     if (has(/과태료|범칙금|미납|납부|환급/)) return "fine_refund_link";
  636:     if (has(/원격|앱설치|설치|팀뷰|애니데|anydesk|지원앱/)) return "bank_install";
  637:     if (has(/인증번호|otp|보안코드/)) return "bank_otp";
  638:     if (has(/비밀번호|로그인|계정|인증\s*실패|잠금/)) return "account_takeover_cred";
  639:     if (has(/주민|계좌|카드번호|신분증|개인정보/)) return "pii_collection";
  640:     if (has(/대출|수수료|보증금|선입금/)) return "loan_fee";
  641:     if (has(/atm|현금인출|은행으로|창구/)) return "go_bank_atm";
  642:     if (has(/퀵|봉투|현금|직접\s*전달|대면/)) return "cash_pickup";
  643: 
  644:     const pool: CaseType[] = [
  645:         "delivery_link",
  646:         "fine_refund_link",
  647:         "bank_otp",
  648:         "bank_install",
  649:         "account_takeover_cred",
  650:         "pii_collection",
  651:         "family_urgent_transfer",
  652:         "loan_fee",
  653:         "go_bank_atm",
  654:         "cash_pickup",
  655:         "job_travel",
  656:         "blackmail_sexvisit",
  657:     ];
  658:     return pick(rng, pool);
  659: }
  660: 
  661: // ---------- 케이스별 설정 ----------
  662: function requiredAnchors(caseType: CaseType): Anchor[] {
  663:     switch (caseType) {
  664:         case "delivery_link":
  665:         case "fine_refund_link":
  666:             return ["A_LINK"];
  667:         case "bank_otp":
  668:             return ["A_OTP"];
  669:         case "bank_install":
  670:             return ["A_INSTALL"];
  671:         case "account_takeover_cred":
  672:             return ["A_CRED"];
  673:         case "pii_collection":
  674:             return ["A_PII"];
  675:         case "family_urgent_transfer":
  676:             return ["A_TRANSFER"];
  677:         case "loan_fee":
  678:             return ["A_TRANSFER"];
  679:         case "go_bank_atm":
  680:             return ["A_GO_BANK"];
  681:         case "cash_pickup":
  682:             return ["A_CASH_PICKUP"];
  683:         case "job_travel":
  684:             return ["A_TRAVEL"];
  685:         case "blackmail_sexvisit":
  686:             return ["A_TRANSFER"];
  687:         default:
  688:             return ["A_TRANSFER"];
  689:     }
  690: }
  691: 
  692: function defaultVectorFor(caseType: CaseType): Vector {
  693:     switch (caseType) {
  694:         case "delivery_link":
  695:         case "fine_refund_link":
  696:         case "account_takeover_cred":
  697:         case "pii_collection":
  698:             return "url";
  699:         default:
  700:             return "none";
  701:     }
  702: }
  703: 
  704: function impersonationFor(caseType: CaseType): string | undefined {
  705:     switch (caseType) {
  706:         case "delivery_link":
  707:             return "imp_delivery";
  708:         case "fine_refund_link":
  709:             return "imp_gov";
  710:         case "bank_otp":
  711:         case "bank_install":
  712:         case "account_takeover_cred":
  713:             return "imp_bank";
  714:         case "go_bank_atm":
  715:             return "imp_court";
  716:         default:
  717:             return undefined;
  718:     }
  719: }
  720: 
  721: function pressuresFor(rng: () => number, caseType: CaseType): string[] {
  722:     switch (caseType) {
  723:         case "blackmail_sexvisit":
  724:             return ["press_threat", "press_secrecy", "press_urgent"];
  631: 
  632:     if (has(/유흥|유포|협박|영상|폭로|불륜|성매매|업소/)) return "blackmail_sexvisit";
  633:     if (has(/출국|항공|비행기|여권|현지|취업|동남아|캄보|라오|태국/)) return "job_travel";
  634:     if (has(/택배|배송|운송장|부재|보관/)) return "delivery_link";
  635:     if (has(/과태료|범칙금|미납|납부|환급/)) return "fine_refund_link";
  636:     if (has(/원격|앱설치|설치|팀뷰|애니데|anydesk|지원앱/)) return "bank_install";
  637:     if (has(/인증번호|otp|보안코드/)) return "bank_otp";
  638:     if (has(/비밀번호|로그인|계정|인증\s*실패|잠금/)) return "account_takeover_cred";
  639:     if (has(/주민|계좌|카드번호|신분증|개인정보/)) return "pii_collection";
  640:     if (has(/대출|수수료|보증금|선입금/)) return "loan_fee";
  641:     if (has(/atm|현금인출|은행으로|창구/)) return "go_bank_atm";
  642:     if (has(/퀵|봉투|현금|직접\s*전달|대면/)) return "cash_pickup";
  643: 
  644:     const pool: CaseType[] = [
  645:         "delivery_link",
  646:         "fine_refund_link",
  647:         "bank_otp",
  648:         "bank_install",
  649:         "account_takeover_cred",
  650:         "pii_collection",
  651:         "family_urgent_transfer",
  652:         "loan_fee",
  653:         "go_bank_atm",
  654:         "cash_pickup",
  655:         "job_travel",
  656:         "blackmail_sexvisit",
  657:     ];
  658:     return pick(rng, pool);
  659: }
  660: 
  661: // ---------- 케이스별 설정 ----------
  662: function requiredAnchors(caseType: CaseType): Anchor[] {
  663:     switch (caseType) {
  664:         case "delivery_link":
  665:         case "fine_refund_link":
  666:             return ["A_LINK"];
  667:         case "bank_otp":
  668:             return ["A_OTP"];
  669:         case "bank_install":
  670:             return ["A_INSTALL"];
  671:         case "account_takeover_cred":
  672:             return ["A_CRED"];
  673:         case "pii_collection":
  674:             return ["A_PII"];
  675:         case "family_urgent_transfer":
  676:             return ["A_TRANSFER"];
  677:         case "loan_fee":
  678:             return ["A_TRANSFER"];
  679:         case "go_bank_atm":
  680:             return ["A_GO_BANK"];
  681:         case "cash_pickup":
  682:             return ["A_CASH_PICKUP"];
  683:         case "job_travel":
  684:             return ["A_TRAVEL"];
  685:         case "blackmail_sexvisit":
  686:             return ["A_TRANSFER"];
  687:         default:
  688:             return ["A_TRANSFER"];
  689:     }
  690: }
  691: 
  692: function defaultVectorFor(caseType: CaseType): Vector {
  693:     switch (caseType) {
  694:         case "delivery_link":
  695:         case "fine_refund_link":
  696:         case "account_takeover_cred":
  697:         case "pii_collection":
  698:             return "url";
  699:         default:
  700:             return "none";
  701:     }
  702: }
  703: 
  704: function impersonationFor(caseType: CaseType): string | undefined {
  705:     switch (caseType) {
  706:         case "delivery_link":
  707:             return "imp_delivery";
  708:         case "fine_refund_link":
  709:             return "imp_gov";
  710:         case "bank_otp":
  711:         case "bank_install":
  712:         case "account_takeover_cred":
  713:             return "imp_bank";
  714:         case "go_bank_atm":
  715:             return "imp_court";
  716:         default:
  717:             return undefined;
  718:     }
  719: }
  720: 
  721: function pressuresFor(rng: () => number, caseType: CaseType): string[] {
  722:     switch (caseType) {
  723:         case "blackmail_sexvisit":
  724:             return ["press_threat", "press_secrecy", "press_urgent"];
  725: 
  726:         case "family_urgent_transfer":
  727:             return ["press_urgent", "press_secrecy"];
  728: 
  729:         case "bank_install":
  730:         case "bank_otp":
  731:         case "loan_fee":
  642:     if (has(/퀵|봉투|현금|직접\s*전달|대면/)) return "cash_pickup";
  643: 
  644:     const pool: CaseType[] = [
  645:         "delivery_link",
  646:         "fine_refund_link",
  647:         "bank_otp",
  648:         "bank_install",
  649:         "account_takeover_cred",
  650:         "pii_collection",
  651:         "family_urgent_transfer",
  652:         "loan_fee",
  653:         "go_bank_atm",
  654:         "cash_pickup",
  655:         "job_travel",
  656:         "blackmail_sexvisit",
  657:     ];
  658:     return pick(rng, pool);
  659: }
  660: 
  661: // ---------- 케이스별 설정 ----------
  662: function requiredAnchors(caseType: CaseType): Anchor[] {
  663:     switch (caseType) {
  664:         case "delivery_link":
  665:         case "fine_refund_link":
  666:             return ["A_LINK"];
  667:         case "bank_otp":
  668:             return ["A_OTP"];
  669:         case "bank_install":
  670:             return ["A_INSTALL"];
  671:         case "account_takeover_cred":
  672:             return ["A_CRED"];
  673:         case "pii_collection":
  674:             return ["A_PII"];
  675:         case "family_urgent_transfer":
  676:             return ["A_TRANSFER"];
  677:         case "loan_fee":
  678:             return ["A_TRANSFER"];
  679:         case "go_bank_atm":
  680:             return ["A_GO_BANK"];
  681:         case "cash_pickup":
  682:             return ["A_CASH_PICKUP"];
  683:         case "job_travel":
  684:             return ["A_TRAVEL"];
  685:         case "blackmail_sexvisit":
  686:             return ["A_TRANSFER"];
  687:         default:
  688:             return ["A_TRANSFER"];
  689:     }
  690: }
  691: 
  692: function defaultVectorFor(caseType: CaseType): Vector {
  693:     switch (caseType) {
  694:         case "delivery_link":
  695:         case "fine_refund_link":
  696:         case "account_takeover_cred":
  697:         case "pii_collection":
  698:             return "url";
  699:         default:
  700:             return "none";
  701:     }
  702: }
  703: 
  704: function impersonationFor(caseType: CaseType): string | undefined {
  705:     switch (caseType) {
  706:         case "delivery_link":
  707:             return "imp_delivery";
  708:         case "fine_refund_link":
  709:             return "imp_gov";
  710:         case "bank_otp":
  711:         case "bank_install":
  712:         case "account_takeover_cred":
  713:             return "imp_bank";
  714:         case "go_bank_atm":
  715:             return "imp_court";
  716:         default:
  717:             return undefined;
  718:     }
  719: }
  720: 
  721: function pressuresFor(rng: () => number, caseType: CaseType): string[] {
  722:     switch (caseType) {
  723:         case "blackmail_sexvisit":
  724:             return ["press_threat", "press_secrecy", "press_urgent"];
  725: 
  726:         case "family_urgent_transfer":
  727:             return ["press_urgent", "press_secrecy"];
  728: 
  729:         case "bank_install":
  730:         case "bank_otp":
  731:         case "loan_fee":
  732:             return ["press_urgent"];
  733: 
  734:         // ✅ ATM/현금전달은 보통 “지금 당장 + 외부에 말하지마”가 같이 붙음
  735:         case "go_bank_atm":
  736:         case "cash_pickup":
  737:             return ["press_urgent", "press_secrecy"];
  738: 
  739:         // 링크형도 너무 “평문 안내”면 낮게 나올 수 있어 가끔 급한 톤을 줌
  740:         case "delivery_link":
  741:         case "fine_refund_link":
  742:             return chance(rng, 0.5) ? ["press_urgent"] : [];
  643: 
  644:     const pool: CaseType[] = [
  645:         "delivery_link",
  646:         "fine_refund_link",
  647:         "bank_otp",
  648:         "bank_install",
  649:         "account_takeover_cred",
  650:         "pii_collection",
  651:         "family_urgent_transfer",
  652:         "loan_fee",
  653:         "go_bank_atm",
  654:         "cash_pickup",
  655:         "job_travel",
  656:         "blackmail_sexvisit",
  657:     ];
  658:     return pick(rng, pool);
  659: }
  660: 
  661: // ---------- 케이스별 설정 ----------
  662: function requiredAnchors(caseType: CaseType): Anchor[] {
  663:     switch (caseType) {
  664:         case "delivery_link":
  665:         case "fine_refund_link":
  666:             return ["A_LINK"];
  667:         case "bank_otp":
  668:             return ["A_OTP"];
  669:         case "bank_install":
  670:             return ["A_INSTALL"];
  671:         case "account_takeover_cred":
  672:             return ["A_CRED"];
  673:         case "pii_collection":
  674:             return ["A_PII"];
  675:         case "family_urgent_transfer":
  676:             return ["A_TRANSFER"];
  677:         case "loan_fee":
  678:             return ["A_TRANSFER"];
  679:         case "go_bank_atm":
  680:             return ["A_GO_BANK"];
  681:         case "cash_pickup":
  682:             return ["A_CASH_PICKUP"];
  683:         case "job_travel":
  684:             return ["A_TRAVEL"];
  685:         case "blackmail_sexvisit":
  686:             return ["A_TRANSFER"];
  687:         default:
  688:             return ["A_TRANSFER"];
  689:     }
  690: }
  691: 
  692: function defaultVectorFor(caseType: CaseType): Vector {
  693:     switch (caseType) {
  694:         case "delivery_link":
  695:         case "fine_refund_link":
  696:         case "account_takeover_cred":
  697:         case "pii_collection":
  698:             return "url";
  699:         default:
  700:             return "none";
  701:     }
  702: }
  703: 
  704: function impersonationFor(caseType: CaseType): string | undefined {
  705:     switch (caseType) {
  706:         case "delivery_link":
  707:             return "imp_delivery";
  708:         case "fine_refund_link":
  709:             return "imp_gov";
  710:         case "bank_otp":
  711:         case "bank_install":
  712:         case "account_takeover_cred":
  713:             return "imp_bank";
  714:         case "go_bank_atm":
  715:             return "imp_court";
  716:         default:
  717:             return undefined;
  718:     }
  719: }
  720: 
  721: function pressuresFor(rng: () => number, caseType: CaseType): string[] {
  722:     switch (caseType) {
  723:         case "blackmail_sexvisit":
  724:             return ["press_threat", "press_secrecy", "press_urgent"];
  725: 
  726:         case "family_urgent_transfer":
  727:             return ["press_urgent", "press_secrecy"];
  728: 
  729:         case "bank_install":
  730:         case "bank_otp":
  731:         case "loan_fee":
  732:             return ["press_urgent"];
  733: 
  734:         // ✅ ATM/현금전달은 보통 “지금 당장 + 외부에 말하지마”가 같이 붙음
  735:         case "go_bank_atm":
  736:         case "cash_pickup":
  737:             return ["press_urgent", "press_secrecy"];
  738: 
  739:         // 링크형도 너무 “평문 안내”면 낮게 나올 수 있어 가끔 급한 톤을 줌
  740:         case "delivery_link":
  741:         case "fine_refund_link":
  742:             return chance(rng, 0.5) ? ["press_urgent"] : [];
  743: 
  655:         "job_travel",
  656:         "blackmail_sexvisit",
  657:     ];
  658:     return pick(rng, pool);
  659: }
  660: 
  661: // ---------- 케이스별 설정 ----------
  662: function requiredAnchors(caseType: CaseType): Anchor[] {
  663:     switch (caseType) {
  664:         case "delivery_link":
  665:         case "fine_refund_link":
  666:             return ["A_LINK"];
  667:         case "bank_otp":
  668:             return ["A_OTP"];
  669:         case "bank_install":
  670:             return ["A_INSTALL"];
  671:         case "account_takeover_cred":
  672:             return ["A_CRED"];
  673:         case "pii_collection":
  674:             return ["A_PII"];
  675:         case "family_urgent_transfer":
  676:             return ["A_TRANSFER"];
  677:         case "loan_fee":
  678:             return ["A_TRANSFER"];
  679:         case "go_bank_atm":
  680:             return ["A_GO_BANK"];
  681:         case "cash_pickup":
  682:             return ["A_CASH_PICKUP"];
  683:         case "job_travel":
  684:             return ["A_TRAVEL"];
  685:         case "blackmail_sexvisit":
  686:             return ["A_TRANSFER"];
  687:         default:
  688:             return ["A_TRANSFER"];
  689:     }
  690: }
  691: 
  692: function defaultVectorFor(caseType: CaseType): Vector {
  693:     switch (caseType) {
  694:         case "delivery_link":
  695:         case "fine_refund_link":
  696:         case "account_takeover_cred":
  697:         case "pii_collection":
  698:             return "url";
  699:         default:
  700:             return "none";
  701:     }
  702: }
  703: 
  704: function impersonationFor(caseType: CaseType): string | undefined {
  705:     switch (caseType) {
  706:         case "delivery_link":
  707:             return "imp_delivery";
  708:         case "fine_refund_link":
  709:             return "imp_gov";
  710:         case "bank_otp":
  711:         case "bank_install":
  712:         case "account_takeover_cred":
  713:             return "imp_bank";
  714:         case "go_bank_atm":
  715:             return "imp_court";
  716:         default:
  717:             return undefined;
  718:     }
  719: }
  720: 
  721: function pressuresFor(rng: () => number, caseType: CaseType): string[] {
  722:     switch (caseType) {
  723:         case "blackmail_sexvisit":
  724:             return ["press_threat", "press_secrecy", "press_urgent"];
  725: 
  726:         case "family_urgent_transfer":
  727:             return ["press_urgent", "press_secrecy"];
  728: 
  729:         case "bank_install":
  730:         case "bank_otp":
  731:         case "loan_fee":
  732:             return ["press_urgent"];
  733: 
  734:         // ✅ ATM/현금전달은 보통 “지금 당장 + 외부에 말하지마”가 같이 붙음
  735:         case "go_bank_atm":
  736:         case "cash_pickup":
  737:             return ["press_urgent", "press_secrecy"];
  738: 
  739:         // 링크형도 너무 “평문 안내”면 낮게 나올 수 있어 가끔 급한 톤을 줌
  740:         case "delivery_link":
  741:         case "fine_refund_link":
  742:             return chance(rng, 0.5) ? ["press_urgent"] : [];
  743: 
  744:         default:
  745:             return [];
  746:     }
  747: }
  748: 
  749: function stageFromAnchors(
  750:     caseType: CaseType,
  751:     anchors: Anchor[],
  752:     vector: Vector,
  753:     urlKind: UrlKind | undefined,
  754:     urlMatch: boolean | undefined,
  755:     pressures: string[],
  672:             return ["A_CRED"];
  673:         case "pii_collection":
  674:             return ["A_PII"];
  675:         case "family_urgent_transfer":
  676:             return ["A_TRANSFER"];
  677:         case "loan_fee":
  678:             return ["A_TRANSFER"];
  679:         case "go_bank_atm":
  680:             return ["A_GO_BANK"];
  681:         case "cash_pickup":
  682:             return ["A_CASH_PICKUP"];
  683:         case "job_travel":
  684:             return ["A_TRAVEL"];
  685:         case "blackmail_sexvisit":
  686:             return ["A_TRANSFER"];
  687:         default:
  688:             return ["A_TRANSFER"];
  689:     }
  690: }
  691: 
  692: function defaultVectorFor(caseType: CaseType): Vector {
  693:     switch (caseType) {
  694:         case "delivery_link":
  695:         case "fine_refund_link":
  696:         case "account_takeover_cred":
  697:         case "pii_collection":
  698:             return "url";
  699:         default:
  700:             return "none";
  701:     }
  702: }
  703: 
  704: function impersonationFor(caseType: CaseType): string | undefined {
  705:     switch (caseType) {
  706:         case "delivery_link":
  707:             return "imp_delivery";
  708:         case "fine_refund_link":
  709:             return "imp_gov";
  710:         case "bank_otp":
  711:         case "bank_install":
  712:         case "account_takeover_cred":
  713:             return "imp_bank";
  714:         case "go_bank_atm":
  715:             return "imp_court";
  716:         default:
  717:             return undefined;
  718:     }
  719: }
  720: 
  721: function pressuresFor(rng: () => number, caseType: CaseType): string[] {
  722:     switch (caseType) {
  723:         case "blackmail_sexvisit":
  724:             return ["press_threat", "press_secrecy", "press_urgent"];
  725: 
  726:         case "family_urgent_transfer":
  727:             return ["press_urgent", "press_secrecy"];
  728: 
  729:         case "bank_install":
  730:         case "bank_otp":
  731:         case "loan_fee":
  732:             return ["press_urgent"];
  733: 
  734:         // ✅ ATM/현금전달은 보통 “지금 당장 + 외부에 말하지마”가 같이 붙음
  735:         case "go_bank_atm":
  736:         case "cash_pickup":
  737:             return ["press_urgent", "press_secrecy"];
  738: 
  739:         // 링크형도 너무 “평문 안내”면 낮게 나올 수 있어 가끔 급한 톤을 줌
  740:         case "delivery_link":
  741:         case "fine_refund_link":
  742:             return chance(rng, 0.5) ? ["press_urgent"] : [];
  743: 
  744:         default:
  745:             return [];
  746:     }
  747: }
  748: 
  749: function stageFromAnchors(
  750:     caseType: CaseType,
  751:     anchors: Anchor[],
  752:     vector: Vector,
  753:     urlKind: UrlKind | undefined,
  754:     urlMatch: boolean | undefined,
  755:     pressures: string[],
  756:     senderText: string
  757: ): Stage {
  758:     // ✅ 엔진(scoreThread)처럼 "rawThread 텍스트" 기준으로 stage를 산정
  759:     // anchors는 생성 힌트일 뿐, 엔진은 anchors를 보지 않으므로 기대값도 텍스트에 맞춰야 stage mismatch가 줄어듦
  760:     const t = String(senderText || "");
  761: 
  762:     const hasRemote =
  763:         /(원격|원격\s*제어|팀뷰|teamviewer|anydesk|supremo|퀵서포트|quick\s*support)/i.test(t);
  764: 
  765:     const hasApk =
  766:         /(apk|설치\s*파일|앱\s*설치|다운로드|파일\s*설치|프로그램\s*설치|업데이트\s*설치)/i.test(t);
  767: 
  768:     const hasInstallMention =
  769:         /(설치|다운로드|앱\s*설치|원격\s*앱|원격\s*지원|지원\s*앱|뷰어\s*설치)/i.test(t);
  770: 
  771:     const hasPayRequest =
  772:         /(계좌번호|예금주|입금|송금|이체|무통장|remit|wire|현금|인출|withdraw|cash|atm|창구|퀵|대면\s*전달|봉투|납부|지불|충전|선납|보험료|안내\s*계좌|보호\s*계좌|안전\s*계좌|지정\s*계좌)/i.test(
  673:         case "pii_collection":
  674:             return ["A_PII"];
  675:         case "family_urgent_transfer":
  676:             return ["A_TRANSFER"];
  677:         case "loan_fee":
  678:             return ["A_TRANSFER"];
  679:         case "go_bank_atm":
  680:             return ["A_GO_BANK"];
  681:         case "cash_pickup":
  682:             return ["A_CASH_PICKUP"];
  683:         case "job_travel":
  684:             return ["A_TRAVEL"];
  685:         case "blackmail_sexvisit":
  686:             return ["A_TRANSFER"];
  687:         default:
  688:             return ["A_TRANSFER"];
  689:     }
  690: }
  691: 
  692: function defaultVectorFor(caseType: CaseType): Vector {
  693:     switch (caseType) {
  694:         case "delivery_link":
  695:         case "fine_refund_link":
  696:         case "account_takeover_cred":
  697:         case "pii_collection":
  698:             return "url";
  699:         default:
  700:             return "none";
  701:     }
  702: }
  703: 
  704: function impersonationFor(caseType: CaseType): string | undefined {
  705:     switch (caseType) {
  706:         case "delivery_link":
  707:             return "imp_delivery";
  708:         case "fine_refund_link":
  709:             return "imp_gov";
  710:         case "bank_otp":
  711:         case "bank_install":
  712:         case "account_takeover_cred":
  713:             return "imp_bank";
  714:         case "go_bank_atm":
  715:             return "imp_court";
  716:         default:
  717:             return undefined;
  718:     }
  719: }
  720: 
  721: function pressuresFor(rng: () => number, caseType: CaseType): string[] {
  722:     switch (caseType) {
  723:         case "blackmail_sexvisit":
  724:             return ["press_threat", "press_secrecy", "press_urgent"];
  725: 
  726:         case "family_urgent_transfer":
  727:             return ["press_urgent", "press_secrecy"];
  728: 
  729:         case "bank_install":
  730:         case "bank_otp":
  731:         case "loan_fee":
  732:             return ["press_urgent"];
  733: 
  734:         // ✅ ATM/현금전달은 보통 “지금 당장 + 외부에 말하지마”가 같이 붙음
  735:         case "go_bank_atm":
  736:         case "cash_pickup":
  737:             return ["press_urgent", "press_secrecy"];
  738: 
  739:         // 링크형도 너무 “평문 안내”면 낮게 나올 수 있어 가끔 급한 톤을 줌
  740:         case "delivery_link":
  741:         case "fine_refund_link":
  742:             return chance(rng, 0.5) ? ["press_urgent"] : [];
  743: 
  744:         default:
  745:             return [];
  746:     }
  747: }
  748: 
  749: function stageFromAnchors(
  750:     caseType: CaseType,
  751:     anchors: Anchor[],
  752:     vector: Vector,
  753:     urlKind: UrlKind | undefined,
  754:     urlMatch: boolean | undefined,
  755:     pressures: string[],
  756:     senderText: string
  757: ): Stage {
  758:     // ✅ 엔진(scoreThread)처럼 "rawThread 텍스트" 기준으로 stage를 산정
  759:     // anchors는 생성 힌트일 뿐, 엔진은 anchors를 보지 않으므로 기대값도 텍스트에 맞춰야 stage mismatch가 줄어듦
  760:     const t = String(senderText || "");
  761: 
  762:     const hasRemote =
  763:         /(원격|원격\s*제어|팀뷰|teamviewer|anydesk|supremo|퀵서포트|quick\s*support)/i.test(t);
  764: 
  765:     const hasApk =
  766:         /(apk|설치\s*파일|앱\s*설치|다운로드|파일\s*설치|프로그램\s*설치|업데이트\s*설치)/i.test(t);
  767: 
  768:     const hasInstallMention =
  769:         /(설치|다운로드|앱\s*설치|원격\s*앱|원격\s*지원|지원\s*앱|뷰어\s*설치)/i.test(t);
  770: 
  771:     const hasPayRequest =
  772:         /(계좌번호|예금주|입금|송금|이체|무통장|remit|wire|현금|인출|withdraw|cash|atm|창구|퀵|대면\s*전달|봉투|납부|지불|충전|선납|보험료|안내\s*계좌|보호\s*계좌|안전\s*계좌|지정\s*계좌)/i.test(
  773:             t
  684:             return ["A_TRAVEL"];
  685:         case "blackmail_sexvisit":
  686:             return ["A_TRANSFER"];
  687:         default:
  688:             return ["A_TRANSFER"];
  689:     }
  690: }
  691: 
  692: function defaultVectorFor(caseType: CaseType): Vector {
  693:     switch (caseType) {
  694:         case "delivery_link":
  695:         case "fine_refund_link":
  696:         case "account_takeover_cred":
  697:         case "pii_collection":
  698:             return "url";
  699:         default:
  700:             return "none";
  701:     }
  702: }
  703: 
  704: function impersonationFor(caseType: CaseType): string | undefined {
  705:     switch (caseType) {
  706:         case "delivery_link":
  707:             return "imp_delivery";
  708:         case "fine_refund_link":
  709:             return "imp_gov";
  710:         case "bank_otp":
  711:         case "bank_install":
  712:         case "account_takeover_cred":
  713:             return "imp_bank";
  714:         case "go_bank_atm":
  715:             return "imp_court";
  716:         default:
  717:             return undefined;
  718:     }
  719: }
  720: 
  721: function pressuresFor(rng: () => number, caseType: CaseType): string[] {
  722:     switch (caseType) {
  723:         case "blackmail_sexvisit":
  724:             return ["press_threat", "press_secrecy", "press_urgent"];
  725: 
  726:         case "family_urgent_transfer":
  727:             return ["press_urgent", "press_secrecy"];
  728: 
  729:         case "bank_install":
  730:         case "bank_otp":
  731:         case "loan_fee":
  732:             return ["press_urgent"];
  733: 
  734:         // ✅ ATM/현금전달은 보통 “지금 당장 + 외부에 말하지마”가 같이 붙음
  735:         case "go_bank_atm":
  736:         case "cash_pickup":
  737:             return ["press_urgent", "press_secrecy"];
  738: 
  739:         // 링크형도 너무 “평문 안내”면 낮게 나올 수 있어 가끔 급한 톤을 줌
  740:         case "delivery_link":
  741:         case "fine_refund_link":
  742:             return chance(rng, 0.5) ? ["press_urgent"] : [];
  743: 
  744:         default:
  745:             return [];
  746:     }
  747: }
  748: 
  749: function stageFromAnchors(
  750:     caseType: CaseType,
  751:     anchors: Anchor[],
  752:     vector: Vector,
  753:     urlKind: UrlKind | undefined,
  754:     urlMatch: boolean | undefined,
  755:     pressures: string[],
  756:     senderText: string
  757: ): Stage {
  758:     // ✅ 엔진(scoreThread)처럼 "rawThread 텍스트" 기준으로 stage를 산정
  759:     // anchors는 생성 힌트일 뿐, 엔진은 anchors를 보지 않으므로 기대값도 텍스트에 맞춰야 stage mismatch가 줄어듦
  760:     const t = String(senderText || "");
  761: 
  762:     const hasRemote =
  763:         /(원격|원격\s*제어|팀뷰|teamviewer|anydesk|supremo|퀵서포트|quick\s*support)/i.test(t);
  764: 
  765:     const hasApk =
  766:         /(apk|설치\s*파일|앱\s*설치|다운로드|파일\s*설치|프로그램\s*설치|업데이트\s*설치)/i.test(t);
  767: 
  768:     const hasInstallMention =
  769:         /(설치|다운로드|앱\s*설치|원격\s*앱|원격\s*지원|지원\s*앱|뷰어\s*설치)/i.test(t);
  770: 
  771:     const hasPayRequest =
  772:         /(계좌번호|예금주|입금|송금|이체|무통장|remit|wire|현금|인출|withdraw|cash|atm|창구|퀵|대면\s*전달|봉투|납부|지불|충전|선납|보험료|안내\s*계좌|보호\s*계좌|안전\s*계좌|지정\s*계좌)/i.test(
  773:             t
  774:         );
  775: 
  776:     const hasOtp = /(otp|인증번호|인증\s*코드|보안\s*코드)/i.test(t);
  777: 
  778:     const hasPersonal =
  779:         /(비밀번호|비번|패스워드|계정|아이디|신분증|주민등록|여권|카드번호|cvv|cvc|보안카드|인증서|개인정보)/i.test(t);
  780: 
  781:     if (hasRemote || hasApk || hasInstallMention) return "install";
  782:     if (hasPayRequest) return "payment";
  783:     if (hasOtp || hasPersonal) return "verify";
  784: 
  685:         case "blackmail_sexvisit":
  686:             return ["A_TRANSFER"];
  687:         default:
  688:             return ["A_TRANSFER"];
  689:     }
  690: }
  691: 
  692: function defaultVectorFor(caseType: CaseType): Vector {
  693:     switch (caseType) {
  694:         case "delivery_link":
  695:         case "fine_refund_link":
  696:         case "account_takeover_cred":
  697:         case "pii_collection":
  698:             return "url";
  699:         default:
  700:             return "none";
  701:     }
  702: }
  703: 
  704: function impersonationFor(caseType: CaseType): string | undefined {
  705:     switch (caseType) {
  706:         case "delivery_link":
  707:             return "imp_delivery";
  708:         case "fine_refund_link":
  709:             return "imp_gov";
  710:         case "bank_otp":
  711:         case "bank_install":
  712:         case "account_takeover_cred":
  713:             return "imp_bank";
  714:         case "go_bank_atm":
  715:             return "imp_court";
  716:         default:
  717:             return undefined;
  718:     }
  719: }
  720: 
  721: function pressuresFor(rng: () => number, caseType: CaseType): string[] {
  722:     switch (caseType) {
  723:         case "blackmail_sexvisit":
  724:             return ["press_threat", "press_secrecy", "press_urgent"];
  725: 
  726:         case "family_urgent_transfer":
  727:             return ["press_urgent", "press_secrecy"];
  728: 
  729:         case "bank_install":
  730:         case "bank_otp":
  731:         case "loan_fee":
  732:             return ["press_urgent"];
  733: 
  734:         // ✅ ATM/현금전달은 보통 “지금 당장 + 외부에 말하지마”가 같이 붙음
  735:         case "go_bank_atm":
  736:         case "cash_pickup":
  737:             return ["press_urgent", "press_secrecy"];
  738: 
  739:         // 링크형도 너무 “평문 안내”면 낮게 나올 수 있어 가끔 급한 톤을 줌
  740:         case "delivery_link":
  741:         case "fine_refund_link":
  742:             return chance(rng, 0.5) ? ["press_urgent"] : [];
  743: 
  744:         default:
  745:             return [];
  746:     }
  747: }
  748: 
  749: function stageFromAnchors(
  750:     caseType: CaseType,
  751:     anchors: Anchor[],
  752:     vector: Vector,
  753:     urlKind: UrlKind | undefined,
  754:     urlMatch: boolean | undefined,
  755:     pressures: string[],
  756:     senderText: string
  757: ): Stage {
  758:     // ✅ 엔진(scoreThread)처럼 "rawThread 텍스트" 기준으로 stage를 산정
  759:     // anchors는 생성 힌트일 뿐, 엔진은 anchors를 보지 않으므로 기대값도 텍스트에 맞춰야 stage mismatch가 줄어듦
  760:     const t = String(senderText || "");
  761: 
  762:     const hasRemote =
  763:         /(원격|원격\s*제어|팀뷰|teamviewer|anydesk|supremo|퀵서포트|quick\s*support)/i.test(t);
  764: 
  765:     const hasApk =
  766:         /(apk|설치\s*파일|앱\s*설치|다운로드|파일\s*설치|프로그램\s*설치|업데이트\s*설치)/i.test(t);
  767: 
  768:     const hasInstallMention =
  769:         /(설치|다운로드|앱\s*설치|원격\s*앱|원격\s*지원|지원\s*앱|뷰어\s*설치)/i.test(t);
  770: 
  771:     const hasPayRequest =
  772:         /(계좌번호|예금주|입금|송금|이체|무통장|remit|wire|현금|인출|withdraw|cash|atm|창구|퀵|대면\s*전달|봉투|납부|지불|충전|선납|보험료|안내\s*계좌|보호\s*계좌|안전\s*계좌|지정\s*계좌)/i.test(
  773:             t
  774:         );
  775: 
  776:     const hasOtp = /(otp|인증번호|인증\s*코드|보안\s*코드)/i.test(t);
  777: 
  778:     const hasPersonal =
  779:         /(비밀번호|비번|패스워드|계정|아이디|신분증|주민등록|여권|카드번호|cvv|cvc|보안카드|인증서|개인정보)/i.test(t);
  780: 
  781:     if (hasRemote || hasApk || hasInstallMention) return "install";
  782:     if (hasPayRequest) return "payment";
  783:     if (hasOtp || hasPersonal) return "verify";
  784: 
  785:     // 링크/QR은 엔진이 info로 두는 경우가 많아서 기본 info
  701:     }
  702: }
  703: 
  704: function impersonationFor(caseType: CaseType): string | undefined {
  705:     switch (caseType) {
  706:         case "delivery_link":
  707:             return "imp_delivery";
  708:         case "fine_refund_link":
  709:             return "imp_gov";
  710:         case "bank_otp":
  711:         case "bank_install":
  712:         case "account_takeover_cred":
  713:             return "imp_bank";
  714:         case "go_bank_atm":
  715:             return "imp_court";
  716:         default:
  717:             return undefined;
  718:     }
  719: }
  720: 
  721: function pressuresFor(rng: () => number, caseType: CaseType): string[] {
  722:     switch (caseType) {
  723:         case "blackmail_sexvisit":
  724:             return ["press_threat", "press_secrecy", "press_urgent"];
  725: 
  726:         case "family_urgent_transfer":
  727:             return ["press_urgent", "press_secrecy"];
  728: 
  729:         case "bank_install":
  730:         case "bank_otp":
  731:         case "loan_fee":
  732:             return ["press_urgent"];
  733: 
  734:         // ✅ ATM/현금전달은 보통 “지금 당장 + 외부에 말하지마”가 같이 붙음
  735:         case "go_bank_atm":
  736:         case "cash_pickup":
  737:             return ["press_urgent", "press_secrecy"];
  738: 
  739:         // 링크형도 너무 “평문 안내”면 낮게 나올 수 있어 가끔 급한 톤을 줌
  740:         case "delivery_link":
  741:         case "fine_refund_link":
  742:             return chance(rng, 0.5) ? ["press_urgent"] : [];
  743: 
  744:         default:
  745:             return [];
  746:     }
  747: }
  748: 
  749: function stageFromAnchors(
  750:     caseType: CaseType,
  751:     anchors: Anchor[],
  752:     vector: Vector,
  753:     urlKind: UrlKind | undefined,
  754:     urlMatch: boolean | undefined,
  755:     pressures: string[],
  756:     senderText: string
  757: ): Stage {
  758:     // ✅ 엔진(scoreThread)처럼 "rawThread 텍스트" 기준으로 stage를 산정
  759:     // anchors는 생성 힌트일 뿐, 엔진은 anchors를 보지 않으므로 기대값도 텍스트에 맞춰야 stage mismatch가 줄어듦
  760:     const t = String(senderText || "");
  761: 
  762:     const hasRemote =
  763:         /(원격|원격\s*제어|팀뷰|teamviewer|anydesk|supremo|퀵서포트|quick\s*support)/i.test(t);
  764: 
  765:     const hasApk =
  766:         /(apk|설치\s*파일|앱\s*설치|다운로드|파일\s*설치|프로그램\s*설치|업데이트\s*설치)/i.test(t);
  767: 
  768:     const hasInstallMention =
  769:         /(설치|다운로드|앱\s*설치|원격\s*앱|원격\s*지원|지원\s*앱|뷰어\s*설치)/i.test(t);
  770: 
  771:     const hasPayRequest =
  772:         /(계좌번호|예금주|입금|송금|이체|무통장|remit|wire|현금|인출|withdraw|cash|atm|창구|퀵|대면\s*전달|봉투|납부|지불|충전|선납|보험료|안내\s*계좌|보호\s*계좌|안전\s*계좌|지정\s*계좌)/i.test(
  773:             t
  774:         );
  775: 
  776:     const hasOtp = /(otp|인증번호|인증\s*코드|보안\s*코드)/i.test(t);
  777: 
  778:     const hasPersonal =
  779:         /(비밀번호|비번|패스워드|계정|아이디|신분증|주민등록|여권|카드번호|cvv|cvc|보안카드|인증서|개인정보)/i.test(t);
  780: 
  781:     if (hasRemote || hasApk || hasInstallMention) return "install";
  782:     if (hasPayRequest) return "payment";
  783:     if (hasOtp || hasPersonal) return "verify";
  784: 
  785:     // 링크/QR은 엔진이 info로 두는 경우가 많아서 기본 info
  786:     return "info";
  787: }
  788: 
  789: function riskFromSignals(
  790:     anchors: Anchor[],
  791:     pressures: string[],
  792:     impersonation?: string,
  793:     vector?: Vector,
  794:     urlKind?: UrlKind,
  795:     urlMatch?: boolean,
  796:     senderText?: string
  797: ): Risk {
  798:     const rawThread = String(senderText || "");
  799:     const ps = new Set((pressures || []).map((x) => String(x || "")));
  800: 
  801:     // ✅ 링크/QR 존재 여부는 "텍스트"로만 판단(anchors 힌트로 false positive 금지)
  702: }
  703: 
  704: function impersonationFor(caseType: CaseType): string | undefined {
  705:     switch (caseType) {
  706:         case "delivery_link":
  707:             return "imp_delivery";
  708:         case "fine_refund_link":
  709:             return "imp_gov";
  710:         case "bank_otp":
  711:         case "bank_install":
  712:         case "account_takeover_cred":
  713:             return "imp_bank";
  714:         case "go_bank_atm":
  715:             return "imp_court";
  716:         default:
  717:             return undefined;
  718:     }
  719: }
  720: 
  721: function pressuresFor(rng: () => number, caseType: CaseType): string[] {
  722:     switch (caseType) {
  723:         case "blackmail_sexvisit":
  724:             return ["press_threat", "press_secrecy", "press_urgent"];
  725: 
  726:         case "family_urgent_transfer":
  727:             return ["press_urgent", "press_secrecy"];
  728: 
  729:         case "bank_install":
  730:         case "bank_otp":
  731:         case "loan_fee":
  732:             return ["press_urgent"];
  733: 
  734:         // ✅ ATM/현금전달은 보통 “지금 당장 + 외부에 말하지마”가 같이 붙음
  735:         case "go_bank_atm":
  736:         case "cash_pickup":
  737:             return ["press_urgent", "press_secrecy"];
  738: 
  739:         // 링크형도 너무 “평문 안내”면 낮게 나올 수 있어 가끔 급한 톤을 줌
  740:         case "delivery_link":
  741:         case "fine_refund_link":
  742:             return chance(rng, 0.5) ? ["press_urgent"] : [];
  743: 
  744:         default:
  745:             return [];
  746:     }
  747: }
  748: 
  749: function stageFromAnchors(
  750:     caseType: CaseType,
  751:     anchors: Anchor[],
  752:     vector: Vector,
  753:     urlKind: UrlKind | undefined,
  754:     urlMatch: boolean | undefined,
  755:     pressures: string[],
  756:     senderText: string
  757: ): Stage {
  758:     // ✅ 엔진(scoreThread)처럼 "rawThread 텍스트" 기준으로 stage를 산정
  759:     // anchors는 생성 힌트일 뿐, 엔진은 anchors를 보지 않으므로 기대값도 텍스트에 맞춰야 stage mismatch가 줄어듦
  760:     const t = String(senderText || "");
  761: 
  762:     const hasRemote =
  763:         /(원격|원격\s*제어|팀뷰|teamviewer|anydesk|supremo|퀵서포트|quick\s*support)/i.test(t);
  764: 
  765:     const hasApk =
  766:         /(apk|설치\s*파일|앱\s*설치|다운로드|파일\s*설치|프로그램\s*설치|업데이트\s*설치)/i.test(t);
  767: 
  768:     const hasInstallMention =
  769:         /(설치|다운로드|앱\s*설치|원격\s*앱|원격\s*지원|지원\s*앱|뷰어\s*설치)/i.test(t);
  770: 
  771:     const hasPayRequest =
  772:         /(계좌번호|예금주|입금|송금|이체|무통장|remit|wire|현금|인출|withdraw|cash|atm|창구|퀵|대면\s*전달|봉투|납부|지불|충전|선납|보험료|안내\s*계좌|보호\s*계좌|안전\s*계좌|지정\s*계좌)/i.test(
  773:             t
  774:         );
  775: 
  776:     const hasOtp = /(otp|인증번호|인증\s*코드|보안\s*코드)/i.test(t);
  777: 
  778:     const hasPersonal =
  779:         /(비밀번호|비번|패스워드|계정|아이디|신분증|주민등록|여권|카드번호|cvv|cvc|보안카드|인증서|개인정보)/i.test(t);
  780: 
  781:     if (hasRemote || hasApk || hasInstallMention) return "install";
  782:     if (hasPayRequest) return "payment";
  783:     if (hasOtp || hasPersonal) return "verify";
  784: 
  785:     // 링크/QR은 엔진이 info로 두는 경우가 많아서 기본 info
  786:     return "info";
  787: }
  788: 
  789: function riskFromSignals(
  790:     anchors: Anchor[],
  791:     pressures: string[],
  792:     impersonation?: string,
  793:     vector?: Vector,
  794:     urlKind?: UrlKind,
  795:     urlMatch?: boolean,
  796:     senderText?: string
  797: ): Risk {
  798:     const rawThread = String(senderText || "");
  799:     const ps = new Set((pressures || []).map((x) => String(x || "")));
  800: 
  801:     // ✅ 링크/QR 존재 여부는 "텍스트"로만 판단(anchors 힌트로 false positive 금지)
  802:     const hasUrl = /https?:\/\/\S+|www\./i.test(rawThread);
  706:         case "delivery_link":
  707:             return "imp_delivery";
  708:         case "fine_refund_link":
  709:             return "imp_gov";
  710:         case "bank_otp":
  711:         case "bank_install":
  712:         case "account_takeover_cred":
  713:             return "imp_bank";
  714:         case "go_bank_atm":
  715:             return "imp_court";
  716:         default:
  717:             return undefined;
  718:     }
  719: }
  720: 
  721: function pressuresFor(rng: () => number, caseType: CaseType): string[] {
  722:     switch (caseType) {
  723:         case "blackmail_sexvisit":
  724:             return ["press_threat", "press_secrecy", "press_urgent"];
  725: 
  726:         case "family_urgent_transfer":
  727:             return ["press_urgent", "press_secrecy"];
  728: 
  729:         case "bank_install":
  730:         case "bank_otp":
  731:         case "loan_fee":
  732:             return ["press_urgent"];
  733: 
  734:         // ✅ ATM/현금전달은 보통 “지금 당장 + 외부에 말하지마”가 같이 붙음
  735:         case "go_bank_atm":
  736:         case "cash_pickup":
  737:             return ["press_urgent", "press_secrecy"];
  738: 
  739:         // 링크형도 너무 “평문 안내”면 낮게 나올 수 있어 가끔 급한 톤을 줌
  740:         case "delivery_link":
  741:         case "fine_refund_link":
  742:             return chance(rng, 0.5) ? ["press_urgent"] : [];
  743: 
  744:         default:
  745:             return [];
  746:     }
  747: }
  748: 
  749: function stageFromAnchors(
  750:     caseType: CaseType,
  751:     anchors: Anchor[],
  752:     vector: Vector,
  753:     urlKind: UrlKind | undefined,
  754:     urlMatch: boolean | undefined,
  755:     pressures: string[],
  756:     senderText: string
  757: ): Stage {
  758:     // ✅ 엔진(scoreThread)처럼 "rawThread 텍스트" 기준으로 stage를 산정
  759:     // anchors는 생성 힌트일 뿐, 엔진은 anchors를 보지 않으므로 기대값도 텍스트에 맞춰야 stage mismatch가 줄어듦
  760:     const t = String(senderText || "");
  761: 
  762:     const hasRemote =
  763:         /(원격|원격\s*제어|팀뷰|teamviewer|anydesk|supremo|퀵서포트|quick\s*support)/i.test(t);
  764: 
  765:     const hasApk =
  766:         /(apk|설치\s*파일|앱\s*설치|다운로드|파일\s*설치|프로그램\s*설치|업데이트\s*설치)/i.test(t);
  767: 
  768:     const hasInstallMention =
  769:         /(설치|다운로드|앱\s*설치|원격\s*앱|원격\s*지원|지원\s*앱|뷰어\s*설치)/i.test(t);
  770: 
  771:     const hasPayRequest =
  772:         /(계좌번호|예금주|입금|송금|이체|무통장|remit|wire|현금|인출|withdraw|cash|atm|창구|퀵|대면\s*전달|봉투|납부|지불|충전|선납|보험료|안내\s*계좌|보호\s*계좌|안전\s*계좌|지정\s*계좌)/i.test(
  773:             t
  774:         );
  775: 
  776:     const hasOtp = /(otp|인증번호|인증\s*코드|보안\s*코드)/i.test(t);
  777: 
  778:     const hasPersonal =
  779:         /(비밀번호|비번|패스워드|계정|아이디|신분증|주민등록|여권|카드번호|cvv|cvc|보안카드|인증서|개인정보)/i.test(t);
  780: 
  781:     if (hasRemote || hasApk || hasInstallMention) return "install";
  782:     if (hasPayRequest) return "payment";
  783:     if (hasOtp || hasPersonal) return "verify";
  784: 
  785:     // 링크/QR은 엔진이 info로 두는 경우가 많아서 기본 info
  786:     return "info";
  787: }
  788: 
  789: function riskFromSignals(
  790:     anchors: Anchor[],
  791:     pressures: string[],
  792:     impersonation?: string,
  793:     vector?: Vector,
  794:     urlKind?: UrlKind,
  795:     urlMatch?: boolean,
  796:     senderText?: string
  797: ): Risk {
  798:     const rawThread = String(senderText || "");
  799:     const ps = new Set((pressures || []).map((x) => String(x || "")));
  800: 
  801:     // ✅ 링크/QR 존재 여부는 "텍스트"로만 판단(anchors 힌트로 false positive 금지)
  802:     const hasUrl = /https?:\/\/\S+|www\./i.test(rawThread);
  803:     const hasQrCue = /(qr|큐알|QR\s*코드|스캔)/i.test(rawThread);
  804:     const hasLink = hasUrl || hasQrCue;
  805: 
  806:     const hasShortener =
  730:         case "bank_otp":
  731:         case "loan_fee":
  732:             return ["press_urgent"];
  733: 
  734:         // ✅ ATM/현금전달은 보통 “지금 당장 + 외부에 말하지마”가 같이 붙음
  735:         case "go_bank_atm":
  736:         case "cash_pickup":
  737:             return ["press_urgent", "press_secrecy"];
  738: 
  739:         // 링크형도 너무 “평문 안내”면 낮게 나올 수 있어 가끔 급한 톤을 줌
  740:         case "delivery_link":
  741:         case "fine_refund_link":
  742:             return chance(rng, 0.5) ? ["press_urgent"] : [];
  743: 
  744:         default:
  745:             return [];
  746:     }
  747: }
  748: 
  749: function stageFromAnchors(
  750:     caseType: CaseType,
  751:     anchors: Anchor[],
  752:     vector: Vector,
  753:     urlKind: UrlKind | undefined,
  754:     urlMatch: boolean | undefined,
  755:     pressures: string[],
  756:     senderText: string
  757: ): Stage {
  758:     // ✅ 엔진(scoreThread)처럼 "rawThread 텍스트" 기준으로 stage를 산정
  759:     // anchors는 생성 힌트일 뿐, 엔진은 anchors를 보지 않으므로 기대값도 텍스트에 맞춰야 stage mismatch가 줄어듦
  760:     const t = String(senderText || "");
  761: 
  762:     const hasRemote =
  763:         /(원격|원격\s*제어|팀뷰|teamviewer|anydesk|supremo|퀵서포트|quick\s*support)/i.test(t);
  764: 
  765:     const hasApk =
  766:         /(apk|설치\s*파일|앱\s*설치|다운로드|파일\s*설치|프로그램\s*설치|업데이트\s*설치)/i.test(t);
  767: 
  768:     const hasInstallMention =
  769:         /(설치|다운로드|앱\s*설치|원격\s*앱|원격\s*지원|지원\s*앱|뷰어\s*설치)/i.test(t);
  770: 
  771:     const hasPayRequest =
  772:         /(계좌번호|예금주|입금|송금|이체|무통장|remit|wire|현금|인출|withdraw|cash|atm|창구|퀵|대면\s*전달|봉투|납부|지불|충전|선납|보험료|안내\s*계좌|보호\s*계좌|안전\s*계좌|지정\s*계좌)/i.test(
  773:             t
  774:         );
  775: 
  776:     const hasOtp = /(otp|인증번호|인증\s*코드|보안\s*코드)/i.test(t);
  777: 
  778:     const hasPersonal =
  779:         /(비밀번호|비번|패스워드|계정|아이디|신분증|주민등록|여권|카드번호|cvv|cvc|보안카드|인증서|개인정보)/i.test(t);
  780: 
  781:     if (hasRemote || hasApk || hasInstallMention) return "install";
  782:     if (hasPayRequest) return "payment";
  783:     if (hasOtp || hasPersonal) return "verify";
  784: 
  785:     // 링크/QR은 엔진이 info로 두는 경우가 많아서 기본 info
  786:     return "info";
  787: }
  788: 
  789: function riskFromSignals(
  790:     anchors: Anchor[],
  791:     pressures: string[],
  792:     impersonation?: string,
  793:     vector?: Vector,
  794:     urlKind?: UrlKind,
  795:     urlMatch?: boolean,
  796:     senderText?: string
  797: ): Risk {
  798:     const rawThread = String(senderText || "");
  799:     const ps = new Set((pressures || []).map((x) => String(x || "")));
  800: 
  801:     // ✅ 링크/QR 존재 여부는 "텍스트"로만 판단(anchors 힌트로 false positive 금지)
  802:     const hasUrl = /https?:\/\/\S+|www\./i.test(rawThread);
  803:     const hasQrCue = /(qr|큐알|QR\s*코드|스캔)/i.test(rawThread);
  804:     const hasLink = hasUrl || hasQrCue;
  805: 
  806:     const hasShortener =
  807:         /(bit\.ly|t\.co|me2\.kr|tinyurl\.com|url\.kr|han\.gl|gg\.gg|vo\.la)/i.test(rawThread);
  808: 
  809:     const hasUrgent =
  810:         ps.has("press_urgent") ||
  811:         /(긴급|즉시|지금\s*바로|서둘러|재촉|기한|마감|지연\s*시|오늘\s*까지|금일\s*까지)/i.test(rawThread);
  812: 
  813:     const hasThreat =
  814:         ps.has("press_threat") ||
  815:         /(체포|구속|영장|압류|고소|기소|법적\s*조치|수사|출석\s*요구|계좌\s*정지|처벌)/i.test(rawThread);
  816: 
  817:     const isAuthorityImp =
  818:         !!impersonation && /^imp_(gov|police|prosecutor|court|bank|card)/.test(impersonation);
  819: 
  820:     const hasAuthority =
  821:         isAuthorityImp ||
  822:         /(경찰|검찰|법원|금감원|금융감독원|국세청|관세청|수사관|검사|담당자|은행|카드사|고객센터)/i.test(rawThread);
  823: 
  824:     const hasDemand =
  825:         /(보내\s*주|전달\s*해|입력\s*해|알려\s*주|회신|답장|제출|업로드|등록|확인\s*해\s*주)/i.test(rawThread);
  826: 
  827:     const hasPayRequest =
  828:         /(계좌번호|예금주|입금|송금|이체|무통장|remit|wire|현금|인출|withdraw|cash|atm|창구|퀵|대면\s*전달|봉투)/i.test(
  829:             rawThread
  830:         );
  837:     const hasRemote =
  838:         /(원격|원격\s*제어|팀뷰|teamviewer|anydesk|supremo|퀵서포트|quick\s*support)/i.test(rawThread);
  839: 
  840:     const hasApk =
  841:         /(apk|설치\s*파일|앱\s*설치|다운로드|파일\s*설치|프로그램\s*설치|업데이트\s*설치)/i.test(rawThread);
  842: 
  843:     const hasInstallMention =
  844:         /(설치|다운로드|앱\s*설치|원격\s*앱|원격\s*지원|지원\s*앱|뷰어\s*설치)/i.test(rawThread);
  845: 
  846:     const hasJobScam =
  847:         /(구인|채용|공고|지원|알바|일자리|업무|면접|현지\s*근무|고수익|톡방|오픈채팅|동남아)/i.test(rawThread);
  848: 
  849:     const hasJobPiiRequest =
  850:         /(신분증|여권|주민등록|사진|업로드|올려|제출|전달)/i.test(rawThread);
  851: 
  852:     const jobPiiHigh = hasJobScam && hasLink && hasJobPiiRequest;
  853: 
  854:     const hasInvest =
  855:         /(투자|코인|가상자산|주식|선물|마진|리딩방|수익률|원금\s*보장|고수익\s*확정)/i.test(rawThread);
  856: 
  857:     const hasFamily =
  858:         /(아들|딸|엄마|아빠|가족|지인|친구).*?(사고|납치|급전|합의금|병원|경찰서)/i.test(rawThread);
  859: 
  860:     const hasPersonal =
  861:         /(개인정보|비밀번호|비번|패스워드|계정|아이디|신분증|주민등록|여권|카드번호|cvv|cvc|보안카드|인증서)/i.test(
  862:             rawThread
  863:         );
  864: 
  865:     const financeLike = /(카드|은행|계좌|승인|결제|정지|해지|분실|도난)/i.test(rawThread);
  866: 
  867:     // ---------- 엔진의 "high 금지/캡" 류를 기대값에도 반영 ----------
  868:     const selfAckThread = /(제가\s*아닌데|제가\s*한\s*적\s*없|한\s*적\s*없|접수\s*안\s*했|모르겠|아닌데요)/i.test(rawThread);
  869:     const alertSettingThread =
  870:         /(알림\s*설정|설정\s*변경|설정\s*확인|로그인\s*시도\s*감지|접속\s*시도\s*감지|자동\s*이체\s*등록)/i.test(rawThread);
  871: 
  872:     const promoLike = /(쿠폰|기프티콘|설문|프로모션|이벤트|경품|당첨|무료)/i.test(rawThread);
  873:     const piiLike = /(개인정보|이름|주소|전화번호|연락처|배송|신청|입력)/i.test(rawThread);
  874: 
  875:     const deliveryLikeThread =
  876:         /(택배|배송|배송지|운송장|송장|집화|출고|입고|도착|지연|보관중|배송중|배달중|통관|세관|반품|교환|수취|수령|부재중)/i.test(
  877:             rawThread
  878:         );
  879: 
  880:     // 1) payment/송금 계열은 high (엔진도 score가 크게 뜸)
  881:     if (hasPayRequest || hasExplicitPayWord) return "high";
  882: 
  883:     // 2) 설치/원격은 기본 high, 다만 “원격만(금융/OTP/위협/권위/긴급 없음)”이면 medium 캡
  884:     if (hasRemote || hasApk || hasInstallMention) {
  885:         const remoteOnly =
  886:             !hasPayRequest &&
  887:             !hasExplicitPayWord &&
  888:             !hasOtp &&
  889:             !hasThreat &&
  890:             !hasAuthority &&
  891:             !hasUrgent &&
  892:             !hasJobScam &&
  893:             !hasInvest &&
  894:             !hasFamily;
  895:         return remoteOnly ? "medium" : "high";
  896:     }
  897: 
  898:     // 3) 잡스캠(링크+신분/여권/사진 업로드 요구) high
  899:     if (jobPiiHigh) return "high";
  900: 
  901:     // 4) 투자/가족 급전 high
  902:     if (hasInvest || hasFamily) return "high";
  903: 
  904:     // 5) OTP: 엔진 hardHigh에 잘 걸리는 조합을 high로
  905:     if (hasOtp) {
  906:         // 링크+OTP+요구(demand) or 권위/위협/긴급 or 금융맥락이면 high
  907:         const otpHard =
  908:             (hasLink && hasDemand) || hasAuthority || hasThreat || hasUrgent || financeLike || hasShortener;
  909:         // 단, OTP “안내만” 류(요구 없음)면 medium
  910:         return otpHard ? "high" : "medium";
  911:     }
  912: 
  913:     // 6) 링크+개인정보는 보통 medium (구인/잡스캠 hard는 위에서 high 처리)
  914:     if (hasLink && (hasPersonal || piiLike)) {
  915:         const promoInfoOnly =
  916:             promoLike &&
  917:             piiLike &&
  918:             !hasThreat &&
  919:             !hasAuthority &&
  920:             !hasUrgent &&
  921:             !hasDemand;
  922: 
  923:         if (promoInfoOnly) return "medium";
  924: 
  925:         const personalLinkOnly =
  926:             !hasThreat &&
  927:             !hasAuthority &&
  928:             !hasUrgent &&
  929:             !hasDemand;
  930: 
  931:         return personalLinkOnly ? "medium" : "high";
  932:     }
  933: 
  934:     // 7) 알림/설정/확인 링크 + “내가 했다/아니다”류는 high 금지 → medium
  935:     if (hasLink && (alertSettingThread || selfAckThread)) {
  936:         const noHard =
  937:             !hasThreat && !hasAuthority && !hasUrgent && !hasDemand && !hasOtp && !hasPersonal;
  874: 
  875:     const deliveryLikeThread =
  876:         /(택배|배송|배송지|운송장|송장|집화|출고|입고|도착|지연|보관중|배송중|배달중|통관|세관|반품|교환|수취|수령|부재중)/i.test(
  877:             rawThread
  878:         );
  879: 
  880:     // 1) payment/송금 계열은 high (엔진도 score가 크게 뜸)
  881:     if (hasPayRequest || hasExplicitPayWord) return "high";
  882: 
  883:     // 2) 설치/원격은 기본 high, 다만 “원격만(금융/OTP/위협/권위/긴급 없음)”이면 medium 캡
  884:     if (hasRemote || hasApk || hasInstallMention) {
  885:         const remoteOnly =
  886:             !hasPayRequest &&
  887:             !hasExplicitPayWord &&
  888:             !hasOtp &&
  889:             !hasThreat &&
  890:             !hasAuthority &&
  891:             !hasUrgent &&
  892:             !hasJobScam &&
  893:             !hasInvest &&
  894:             !hasFamily;
  895:         return remoteOnly ? "medium" : "high";
  896:     }
  897: 
  898:     // 3) 잡스캠(링크+신분/여권/사진 업로드 요구) high
  899:     if (jobPiiHigh) return "high";
  900: 
  901:     // 4) 투자/가족 급전 high
  902:     if (hasInvest || hasFamily) return "high";
  903: 
  904:     // 5) OTP: 엔진 hardHigh에 잘 걸리는 조합을 high로
  905:     if (hasOtp) {
  906:         // 링크+OTP+요구(demand) or 권위/위협/긴급 or 금융맥락이면 high
  907:         const otpHard =
  908:             (hasLink && hasDemand) || hasAuthority || hasThreat || hasUrgent || financeLike || hasShortener;
  909:         // 단, OTP “안내만” 류(요구 없음)면 medium
  910:         return otpHard ? "high" : "medium";
  911:     }
  912: 
  913:     // 6) 링크+개인정보는 보통 medium (구인/잡스캠 hard는 위에서 high 처리)
  914:     if (hasLink && (hasPersonal || piiLike)) {
  915:         const promoInfoOnly =
  916:             promoLike &&
  917:             piiLike &&
  918:             !hasThreat &&
  919:             !hasAuthority &&
  920:             !hasUrgent &&
  921:             !hasDemand;
  922: 
  923:         if (promoInfoOnly) return "medium";
  924: 
  925:         const personalLinkOnly =
  926:             !hasThreat &&
  927:             !hasAuthority &&
  928:             !hasUrgent &&
  929:             !hasDemand;
  930: 
  931:         return personalLinkOnly ? "medium" : "high";
  932:     }
  933: 
  934:     // 7) 알림/설정/확인 링크 + “내가 했다/아니다”류는 high 금지 → medium
  935:     if (hasLink && (alertSettingThread || selfAckThread)) {
  936:         const noHard =
  937:             !hasThreat && !hasAuthority && !hasUrgent && !hasDemand && !hasOtp && !hasPersonal;
  938:         return noHard ? "medium" : "high";
  939:     }
  940: 
  941:     // 8) 택배 링크만은 high 금지 → medium/low
  942:     if (hasLink && deliveryLikeThread) {
  943:         const noHard =
  944:             !hasThreat && !hasAuthority && !hasUrgent && !hasDemand && !hasOtp && !hasPersonal;
  945:         return noHard ? "medium" : "high";
  946:     }
  947: 
  948:     // 9) 링크/QR 단독은 low, 단서(긴급/요구/위협/권위/단축) 있으면 medium
  949:     if (hasLink) {
  950:         const hasDanger = hasThreat || hasAuthority || hasUrgent || hasDemand || hasShortener;
  951:         return hasDanger ? "medium" : "low";
  952:     }
  953: 
  954:     return "low";
  955: }
  956: 
  957: function triggersFrom(
  958:     caseType: CaseType,
  959:     anchors: Anchor[],
  960:     pressures: string[],
  961:     impersonation?: string,
  962:     vector?: Vector,
  963:     urlKind?: UrlKind
  964: ) {
  965:     const t: string[] = [];
  966:     if (impersonation) t.push(impersonation);
  967: 
  968:     for (const a of anchors) {
  969:         if (a === "A_LINK") t.push("act_link");
  970:         if (a === "A_QR") t.push("act_qr_scan");
  971:         if (a === "A_INSTALL") t.push("act_install", "act_remote");
  972:         if (a === "A_OTP") t.push("act_otp_relay");
  973:         if (a === "A_TRANSFER") t.push("act_transfer");
  974:         if (a === "A_GO_BANK") t.push("act_go_bank");
  882: 
  883:     // 2) 설치/원격은 기본 high, 다만 “원격만(금융/OTP/위협/권위/긴급 없음)”이면 medium 캡
  884:     if (hasRemote || hasApk || hasInstallMention) {
  885:         const remoteOnly =
  886:             !hasPayRequest &&
  887:             !hasExplicitPayWord &&
  888:             !hasOtp &&
  889:             !hasThreat &&
  890:             !hasAuthority &&
  891:             !hasUrgent &&
  892:             !hasJobScam &&
  893:             !hasInvest &&
  894:             !hasFamily;
  895:         return remoteOnly ? "medium" : "high";
  896:     }
  897: 
  898:     // 3) 잡스캠(링크+신분/여권/사진 업로드 요구) high
  899:     if (jobPiiHigh) return "high";
  900: 
  901:     // 4) 투자/가족 급전 high
  902:     if (hasInvest || hasFamily) return "high";
  903: 
  904:     // 5) OTP: 엔진 hardHigh에 잘 걸리는 조합을 high로
  905:     if (hasOtp) {
  906:         // 링크+OTP+요구(demand) or 권위/위협/긴급 or 금융맥락이면 high
  907:         const otpHard =
  908:             (hasLink && hasDemand) || hasAuthority || hasThreat || hasUrgent || financeLike || hasShortener;
  909:         // 단, OTP “안내만” 류(요구 없음)면 medium
  910:         return otpHard ? "high" : "medium";
  911:     }
  912: 
  913:     // 6) 링크+개인정보는 보통 medium (구인/잡스캠 hard는 위에서 high 처리)
  914:     if (hasLink && (hasPersonal || piiLike)) {
  915:         const promoInfoOnly =
  916:             promoLike &&
  917:             piiLike &&
  918:             !hasThreat &&
  919:             !hasAuthority &&
  920:             !hasUrgent &&
  921:             !hasDemand;
  922: 
  923:         if (promoInfoOnly) return "medium";
  924: 
  925:         const personalLinkOnly =
  926:             !hasThreat &&
  927:             !hasAuthority &&
  928:             !hasUrgent &&
  929:             !hasDemand;
  930: 
  931:         return personalLinkOnly ? "medium" : "high";
  932:     }
  933: 
  934:     // 7) 알림/설정/확인 링크 + “내가 했다/아니다”류는 high 금지 → medium
  935:     if (hasLink && (alertSettingThread || selfAckThread)) {
  936:         const noHard =
  937:             !hasThreat && !hasAuthority && !hasUrgent && !hasDemand && !hasOtp && !hasPersonal;
  938:         return noHard ? "medium" : "high";
  939:     }
  940: 
  941:     // 8) 택배 링크만은 high 금지 → medium/low
  942:     if (hasLink && deliveryLikeThread) {
  943:         const noHard =
  944:             !hasThreat && !hasAuthority && !hasUrgent && !hasDemand && !hasOtp && !hasPersonal;
  945:         return noHard ? "medium" : "high";
  946:     }
  947: 
  948:     // 9) 링크/QR 단독은 low, 단서(긴급/요구/위협/권위/단축) 있으면 medium
  949:     if (hasLink) {
  950:         const hasDanger = hasThreat || hasAuthority || hasUrgent || hasDemand || hasShortener;
  951:         return hasDanger ? "medium" : "low";
  952:     }
  953: 
  954:     return "low";
  955: }
  956: 
  957: function triggersFrom(
  958:     caseType: CaseType,
  959:     anchors: Anchor[],
  960:     pressures: string[],
  961:     impersonation?: string,
  962:     vector?: Vector,
  963:     urlKind?: UrlKind
  964: ) {
  965:     const t: string[] = [];
  966:     if (impersonation) t.push(impersonation);
  967: 
  968:     for (const a of anchors) {
  969:         if (a === "A_LINK") t.push("act_link");
  970:         if (a === "A_QR") t.push("act_qr_scan");
  971:         if (a === "A_INSTALL") t.push("act_install", "act_remote");
  972:         if (a === "A_OTP") t.push("act_otp_relay");
  973:         if (a === "A_TRANSFER") t.push("act_transfer");
  974:         if (a === "A_GO_BANK") t.push("act_go_bank");
  975:         if (a === "A_CASH_PICKUP") t.push("act_cash_pickup");
  976: 
  977:         // ✅ 엔진에 맞추기: travel은 job_lure로
  978:         if (a === "A_TRAVEL") t.push("job_lure");
  979: 
  980:         if (a === "A_CRED") t.push("req_credentials");
  981:         if (a === "A_PII") t.push("req_personal");
  982:     }
  938:         return noHard ? "medium" : "high";
  939:     }
  940: 
  941:     // 8) 택배 링크만은 high 금지 → medium/low
  942:     if (hasLink && deliveryLikeThread) {
  943:         const noHard =
  944:             !hasThreat && !hasAuthority && !hasUrgent && !hasDemand && !hasOtp && !hasPersonal;
  945:         return noHard ? "medium" : "high";
  946:     }
  947: 
  948:     // 9) 링크/QR 단독은 low, 단서(긴급/요구/위협/권위/단축) 있으면 medium
  949:     if (hasLink) {
  950:         const hasDanger = hasThreat || hasAuthority || hasUrgent || hasDemand || hasShortener;
  951:         return hasDanger ? "medium" : "low";
  952:     }
  953: 
  954:     return "low";
  955: }
  956: 
  957: function triggersFrom(
  958:     caseType: CaseType,
  959:     anchors: Anchor[],
  960:     pressures: string[],
  961:     impersonation?: string,
  962:     vector?: Vector,
  963:     urlKind?: UrlKind
  964: ) {
  965:     const t: string[] = [];
  966:     if (impersonation) t.push(impersonation);
  967: 
  968:     for (const a of anchors) {
  969:         if (a === "A_LINK") t.push("act_link");
  970:         if (a === "A_QR") t.push("act_qr_scan");
  971:         if (a === "A_INSTALL") t.push("act_install", "act_remote");
  972:         if (a === "A_OTP") t.push("act_otp_relay");
  973:         if (a === "A_TRANSFER") t.push("act_transfer");
  974:         if (a === "A_GO_BANK") t.push("act_go_bank");
  975:         if (a === "A_CASH_PICKUP") t.push("act_cash_pickup");
  976: 
  977:         // ✅ 엔진에 맞추기: travel은 job_lure로
  978:         if (a === "A_TRAVEL") t.push("job_lure");
  979: 
  980:         if (a === "A_CRED") t.push("req_credentials");
  981:         if (a === "A_PII") t.push("req_personal");
  982:     }
  983: 
  984:     for (const p of pressures) t.push(p);
  985: 
  986:     if (vector === "url") t.push("vector_url");
  987:     if (vector === "qr") t.push("vector_qr");
  988:     if (urlKind === "short") t.push("act_shortlink");
  989:     if (urlKind === "typo") t.push("url_typo");
  990:     if (urlKind === "homoglyph") t.push("url_homoglyph");
  991: 
  992:     // 케이스 라벨도 엔진쪽으로 최소 정렬(필요하면 추가 확장)
  993:     if (caseType === "job_travel") t.push("job_lure");
  994:     if (caseType === "blackmail_sexvisit") t.push("cat_blackmail");
  995: 
  996:     return uniqSorted(t);
  997: }
  998: 
  999: // ---------- 대화 생성(방어/데모 톤, 어미/동의어/오타 다양화 포함) ----------
 1000: function buildConversation(
 1001:     rng: () => number,
 1002:     caseType: CaseType,
 1003:     anchors: Anchor[],
 1004:     vector: Vector,
 1005:     urlStr: string | undefined,
 1006:     urlKind: UrlKind | undefined,
 1007:     noiseLevel: "none" | "low" | "mid" | "high",
 1008:     maxLen: number,
 1009:     callerDisplay: string,
 1010:     stubKeywords: string[],
 1011:     pressures: string[],
 1012:     impersonation?: string,
 1013: ): ScenarioTurn[] {
 1014:     const tone = pickTone(rng);
 1015: 
 1016:     const ORG = (() => {
 1017:         // ✅ 엔진이 실제로 잡기 쉬운 한국어 키워드 포함
 1018:         if (impersonation === "imp_bank") return pick(rng, ["OO은행", "OO카드", "금융감독원"] as const);
 1019:         if (impersonation === "imp_court") return pick(rng, ["OO지방법원", "법원"] as const);
 1020:         if (impersonation === "imp_police") return pick(rng, ["OO경찰서", "경찰"] as const);
 1021:         if (impersonation === "imp_gov") return pick(rng, ["국세청", "정부24", "행정기관"] as const);
 1022:         if (impersonation === "imp_delivery") return pick(rng, ["OO택배", "배송업체"] as const);
 1023: 
 1024:         // fallback
 1025:         if (caseType === "delivery_link") return pick(rng, ["OO택배", "배송업체"] as const);
 1026:         if (caseType.startsWith("bank_") || caseType === "account_takeover_cred") return pick(rng, ["OO은행", "금융감독원"] as const);
 1027:         if (caseType === "go_bank_atm") return pick(rng, ["OO지방법원", "검찰"] as const);
 1028:         return "기관";
 1029:     })();
 1030: 
 1031:     const pretextLines: string[] = [];
 1032:     const credLines: string[] = [];
 1033:     const pressureLines: string[] = [];
 1034:     const anchorLines: string[] = [];
 1035:     const followLines: string[] = [];
 1036: 
 1037:     const callerTag = callerDisplay ? `[발신 ${callerDisplay}] ` : "";
 1038: 
  973:         if (a === "A_TRANSFER") t.push("act_transfer");
  974:         if (a === "A_GO_BANK") t.push("act_go_bank");
  975:         if (a === "A_CASH_PICKUP") t.push("act_cash_pickup");
  976: 
  977:         // ✅ 엔진에 맞추기: travel은 job_lure로
  978:         if (a === "A_TRAVEL") t.push("job_lure");
  979: 
  980:         if (a === "A_CRED") t.push("req_credentials");
  981:         if (a === "A_PII") t.push("req_personal");
  982:     }
  983: 
  984:     for (const p of pressures) t.push(p);
  985: 
  986:     if (vector === "url") t.push("vector_url");
  987:     if (vector === "qr") t.push("vector_qr");
  988:     if (urlKind === "short") t.push("act_shortlink");
  989:     if (urlKind === "typo") t.push("url_typo");
  990:     if (urlKind === "homoglyph") t.push("url_homoglyph");
  991: 
  992:     // 케이스 라벨도 엔진쪽으로 최소 정렬(필요하면 추가 확장)
  993:     if (caseType === "job_travel") t.push("job_lure");
  994:     if (caseType === "blackmail_sexvisit") t.push("cat_blackmail");
  995: 
  996:     return uniqSorted(t);
  997: }
  998: 
  999: // ---------- 대화 생성(방어/데모 톤, 어미/동의어/오타 다양화 포함) ----------
 1000: function buildConversation(
 1001:     rng: () => number,
 1002:     caseType: CaseType,
 1003:     anchors: Anchor[],
 1004:     vector: Vector,
 1005:     urlStr: string | undefined,
 1006:     urlKind: UrlKind | undefined,
 1007:     noiseLevel: "none" | "low" | "mid" | "high",
 1008:     maxLen: number,
 1009:     callerDisplay: string,
 1010:     stubKeywords: string[],
 1011:     pressures: string[],
 1012:     impersonation?: string,
 1013: ): ScenarioTurn[] {
 1014:     const tone = pickTone(rng);
 1015: 
 1016:     const ORG = (() => {
 1017:         // ✅ 엔진이 실제로 잡기 쉬운 한국어 키워드 포함
 1018:         if (impersonation === "imp_bank") return pick(rng, ["OO은행", "OO카드", "금융감독원"] as const);
 1019:         if (impersonation === "imp_court") return pick(rng, ["OO지방법원", "법원"] as const);
 1020:         if (impersonation === "imp_police") return pick(rng, ["OO경찰서", "경찰"] as const);
 1021:         if (impersonation === "imp_gov") return pick(rng, ["국세청", "정부24", "행정기관"] as const);
 1022:         if (impersonation === "imp_delivery") return pick(rng, ["OO택배", "배송업체"] as const);
 1023: 
 1024:         // fallback
 1025:         if (caseType === "delivery_link") return pick(rng, ["OO택배", "배송업체"] as const);
 1026:         if (caseType.startsWith("bank_") || caseType === "account_takeover_cred") return pick(rng, ["OO은행", "금융감독원"] as const);
 1027:         if (caseType === "go_bank_atm") return pick(rng, ["OO지방법원", "검찰"] as const);
 1028:         return "기관";
 1029:     })();
 1030: 
 1031:     const pretextLines: string[] = [];
 1032:     const credLines: string[] = [];
 1033:     const pressureLines: string[] = [];
 1034:     const anchorLines: string[] = [];
 1035:     const followLines: string[] = [];
 1036: 
 1037:     const callerTag = callerDisplay ? `[발신 ${callerDisplay}] ` : "";
 1038: 
 1039:     // ✅ press_*가 실제 텍스트로 들어가야 prefilter/룰이 강하게 잡힘
 1040:     if (pressures.includes("press_urgent")) {
 1041:         pressureLines.push(applyNoiseKo(rng, varyEnding(rng, `긴급 안내입니다. 지금 바로 처리해야 합니다`, tone), noiseLevel));
 1042:     }
 1043:     if (pressures.includes("press_secrecy")) {
 1044:         pressureLines.push(applyNoiseKo(rng, varyEnding(rng, `보안상 외부 공유 금지입니다. 가족/지인에게도 말하지 마세요`, tone), noiseLevel));
 1045:     }
 1046:     if (pressures.includes("press_threat")) {
 1047:         pressureLines.push(applyNoiseKo(rng, varyEnding(rng, `미이행 시 계좌 정지/법적 조치가 진행될 수 있습니다`, tone), noiseLevel));
 1048:     }
 1049: 
 1050:     switch (caseType) {
 1051:         case "delivery_link":
 1052:             pretextLines.push(`${callerTag}${ORG} 안내입니다`);
 1053:             credLines.push(`배송지/보관 관련 확인이 필요합니다`);
 1054:             break;
 1055:         case "fine_refund_link":
 1056:             pretextLines.push(`${callerTag}${ORG} 안내입니다`);
 1057:             credLines.push(`미납/환급 관련 확인이 필요합니다`);
 1058:             break;
 1059:         case "bank_otp":
 1060:             pretextLines.push(`${callerTag}${ORG} 보안 안내입니다`);
 1061:             credLines.push(`본인 확인 절차가 필요합니다`);
 1062:             break;
 1063:         case "bank_install":
 1064:             pretextLines.push(`${callerTag}${ORG} 보안 점검 안내입니다`);
 1065:             credLines.push(`원격 지원 절차가 필요합니다`);
 1066:             break;
 1067:         case "account_takeover_cred":
 1068:             pretextLines.push(`${callerTag}${ORG} 계정 보안 안내입니다`);
 1069:             credLines.push(`로그인 차단 해제를 위해 확인이 필요합니다`);
 1070:             break;
 1071:         case "pii_collection":
 1072:             pretextLines.push(`${callerTag}${ORG} 확인 안내입니다`);
 1073:             credLines.push(`신분 확인을 위해 기초 정보 확인이 필요합니다`);
  974:         if (a === "A_GO_BANK") t.push("act_go_bank");
  975:         if (a === "A_CASH_PICKUP") t.push("act_cash_pickup");
  976: 
  977:         // ✅ 엔진에 맞추기: travel은 job_lure로
  978:         if (a === "A_TRAVEL") t.push("job_lure");
  979: 
  980:         if (a === "A_CRED") t.push("req_credentials");
  981:         if (a === "A_PII") t.push("req_personal");
  982:     }
  983: 
  984:     for (const p of pressures) t.push(p);
  985: 
  986:     if (vector === "url") t.push("vector_url");
  987:     if (vector === "qr") t.push("vector_qr");
  988:     if (urlKind === "short") t.push("act_shortlink");
  989:     if (urlKind === "typo") t.push("url_typo");
  990:     if (urlKind === "homoglyph") t.push("url_homoglyph");
  991: 
  992:     // 케이스 라벨도 엔진쪽으로 최소 정렬(필요하면 추가 확장)
  993:     if (caseType === "job_travel") t.push("job_lure");
  994:     if (caseType === "blackmail_sexvisit") t.push("cat_blackmail");
  995: 
  996:     return uniqSorted(t);
  997: }
  998: 
  999: // ---------- 대화 생성(방어/데모 톤, 어미/동의어/오타 다양화 포함) ----------
 1000: function buildConversation(
 1001:     rng: () => number,
 1002:     caseType: CaseType,
 1003:     anchors: Anchor[],
 1004:     vector: Vector,
 1005:     urlStr: string | undefined,
 1006:     urlKind: UrlKind | undefined,
 1007:     noiseLevel: "none" | "low" | "mid" | "high",
 1008:     maxLen: number,
 1009:     callerDisplay: string,
 1010:     stubKeywords: string[],
 1011:     pressures: string[],
 1012:     impersonation?: string,
 1013: ): ScenarioTurn[] {
 1014:     const tone = pickTone(rng);
 1015: 
 1016:     const ORG = (() => {
 1017:         // ✅ 엔진이 실제로 잡기 쉬운 한국어 키워드 포함
 1018:         if (impersonation === "imp_bank") return pick(rng, ["OO은행", "OO카드", "금융감독원"] as const);
 1019:         if (impersonation === "imp_court") return pick(rng, ["OO지방법원", "법원"] as const);
 1020:         if (impersonation === "imp_police") return pick(rng, ["OO경찰서", "경찰"] as const);
 1021:         if (impersonation === "imp_gov") return pick(rng, ["국세청", "정부24", "행정기관"] as const);
 1022:         if (impersonation === "imp_delivery") return pick(rng, ["OO택배", "배송업체"] as const);
 1023: 
 1024:         // fallback
 1025:         if (caseType === "delivery_link") return pick(rng, ["OO택배", "배송업체"] as const);
 1026:         if (caseType.startsWith("bank_") || caseType === "account_takeover_cred") return pick(rng, ["OO은행", "금융감독원"] as const);
 1027:         if (caseType === "go_bank_atm") return pick(rng, ["OO지방법원", "검찰"] as const);
 1028:         return "기관";
 1029:     })();
 1030: 
 1031:     const pretextLines: string[] = [];
 1032:     const credLines: string[] = [];
 1033:     const pressureLines: string[] = [];
 1034:     const anchorLines: string[] = [];
 1035:     const followLines: string[] = [];
 1036: 
 1037:     const callerTag = callerDisplay ? `[발신 ${callerDisplay}] ` : "";
 1038: 
 1039:     // ✅ press_*가 실제 텍스트로 들어가야 prefilter/룰이 강하게 잡힘
 1040:     if (pressures.includes("press_urgent")) {
 1041:         pressureLines.push(applyNoiseKo(rng, varyEnding(rng, `긴급 안내입니다. 지금 바로 처리해야 합니다`, tone), noiseLevel));
 1042:     }
 1043:     if (pressures.includes("press_secrecy")) {
 1044:         pressureLines.push(applyNoiseKo(rng, varyEnding(rng, `보안상 외부 공유 금지입니다. 가족/지인에게도 말하지 마세요`, tone), noiseLevel));
 1045:     }
 1046:     if (pressures.includes("press_threat")) {
 1047:         pressureLines.push(applyNoiseKo(rng, varyEnding(rng, `미이행 시 계좌 정지/법적 조치가 진행될 수 있습니다`, tone), noiseLevel));
 1048:     }
 1049: 
 1050:     switch (caseType) {
 1051:         case "delivery_link":
 1052:             pretextLines.push(`${callerTag}${ORG} 안내입니다`);
 1053:             credLines.push(`배송지/보관 관련 확인이 필요합니다`);
 1054:             break;
 1055:         case "fine_refund_link":
 1056:             pretextLines.push(`${callerTag}${ORG} 안내입니다`);
 1057:             credLines.push(`미납/환급 관련 확인이 필요합니다`);
 1058:             break;
 1059:         case "bank_otp":
 1060:             pretextLines.push(`${callerTag}${ORG} 보안 안내입니다`);
 1061:             credLines.push(`본인 확인 절차가 필요합니다`);
 1062:             break;
 1063:         case "bank_install":
 1064:             pretextLines.push(`${callerTag}${ORG} 보안 점검 안내입니다`);
 1065:             credLines.push(`원격 지원 절차가 필요합니다`);
 1066:             break;
 1067:         case "account_takeover_cred":
 1068:             pretextLines.push(`${callerTag}${ORG} 계정 보안 안내입니다`);
 1069:             credLines.push(`로그인 차단 해제를 위해 확인이 필요합니다`);
 1070:             break;
 1071:         case "pii_collection":
 1072:             pretextLines.push(`${callerTag}${ORG} 확인 안내입니다`);
 1073:             credLines.push(`신분 확인을 위해 기초 정보 확인이 필요합니다`);
 1074:             break;
  982:     }
  983: 
  984:     for (const p of pressures) t.push(p);
  985: 
  986:     if (vector === "url") t.push("vector_url");
  987:     if (vector === "qr") t.push("vector_qr");
  988:     if (urlKind === "short") t.push("act_shortlink");
  989:     if (urlKind === "typo") t.push("url_typo");
  990:     if (urlKind === "homoglyph") t.push("url_homoglyph");
  991: 
  992:     // 케이스 라벨도 엔진쪽으로 최소 정렬(필요하면 추가 확장)
  993:     if (caseType === "job_travel") t.push("job_lure");
  994:     if (caseType === "blackmail_sexvisit") t.push("cat_blackmail");
  995: 
  996:     return uniqSorted(t);
  997: }
  998: 
  999: // ---------- 대화 생성(방어/데모 톤, 어미/동의어/오타 다양화 포함) ----------
 1000: function buildConversation(
 1001:     rng: () => number,
 1002:     caseType: CaseType,
 1003:     anchors: Anchor[],
 1004:     vector: Vector,
 1005:     urlStr: string | undefined,
 1006:     urlKind: UrlKind | undefined,
 1007:     noiseLevel: "none" | "low" | "mid" | "high",
 1008:     maxLen: number,
 1009:     callerDisplay: string,
 1010:     stubKeywords: string[],
 1011:     pressures: string[],
 1012:     impersonation?: string,
 1013: ): ScenarioTurn[] {
 1014:     const tone = pickTone(rng);
 1015: 
 1016:     const ORG = (() => {
 1017:         // ✅ 엔진이 실제로 잡기 쉬운 한국어 키워드 포함
 1018:         if (impersonation === "imp_bank") return pick(rng, ["OO은행", "OO카드", "금융감독원"] as const);
 1019:         if (impersonation === "imp_court") return pick(rng, ["OO지방법원", "법원"] as const);
 1020:         if (impersonation === "imp_police") return pick(rng, ["OO경찰서", "경찰"] as const);
 1021:         if (impersonation === "imp_gov") return pick(rng, ["국세청", "정부24", "행정기관"] as const);
 1022:         if (impersonation === "imp_delivery") return pick(rng, ["OO택배", "배송업체"] as const);
 1023: 
 1024:         // fallback
 1025:         if (caseType === "delivery_link") return pick(rng, ["OO택배", "배송업체"] as const);
 1026:         if (caseType.startsWith("bank_") || caseType === "account_takeover_cred") return pick(rng, ["OO은행", "금융감독원"] as const);
 1027:         if (caseType === "go_bank_atm") return pick(rng, ["OO지방법원", "검찰"] as const);
 1028:         return "기관";
 1029:     })();
 1030: 
 1031:     const pretextLines: string[] = [];
 1032:     const credLines: string[] = [];
 1033:     const pressureLines: string[] = [];
 1034:     const anchorLines: string[] = [];
 1035:     const followLines: string[] = [];
 1036: 
 1037:     const callerTag = callerDisplay ? `[발신 ${callerDisplay}] ` : "";
 1038: 
 1039:     // ✅ press_*가 실제 텍스트로 들어가야 prefilter/룰이 강하게 잡힘
 1040:     if (pressures.includes("press_urgent")) {
 1041:         pressureLines.push(applyNoiseKo(rng, varyEnding(rng, `긴급 안내입니다. 지금 바로 처리해야 합니다`, tone), noiseLevel));
 1042:     }
 1043:     if (pressures.includes("press_secrecy")) {
 1044:         pressureLines.push(applyNoiseKo(rng, varyEnding(rng, `보안상 외부 공유 금지입니다. 가족/지인에게도 말하지 마세요`, tone), noiseLevel));
 1045:     }
 1046:     if (pressures.includes("press_threat")) {
 1047:         pressureLines.push(applyNoiseKo(rng, varyEnding(rng, `미이행 시 계좌 정지/법적 조치가 진행될 수 있습니다`, tone), noiseLevel));
 1048:     }
 1049: 
 1050:     switch (caseType) {
 1051:         case "delivery_link":
 1052:             pretextLines.push(`${callerTag}${ORG} 안내입니다`);
 1053:             credLines.push(`배송지/보관 관련 확인이 필요합니다`);
 1054:             break;
 1055:         case "fine_refund_link":
 1056:             pretextLines.push(`${callerTag}${ORG} 안내입니다`);
 1057:             credLines.push(`미납/환급 관련 확인이 필요합니다`);
 1058:             break;
 1059:         case "bank_otp":
 1060:             pretextLines.push(`${callerTag}${ORG} 보안 안내입니다`);
 1061:             credLines.push(`본인 확인 절차가 필요합니다`);
 1062:             break;
 1063:         case "bank_install":
 1064:             pretextLines.push(`${callerTag}${ORG} 보안 점검 안내입니다`);
 1065:             credLines.push(`원격 지원 절차가 필요합니다`);
 1066:             break;
 1067:         case "account_takeover_cred":
 1068:             pretextLines.push(`${callerTag}${ORG} 계정 보안 안내입니다`);
 1069:             credLines.push(`로그인 차단 해제를 위해 확인이 필요합니다`);
 1070:             break;
 1071:         case "pii_collection":
 1072:             pretextLines.push(`${callerTag}${ORG} 확인 안내입니다`);
 1073:             credLines.push(`신분 확인을 위해 기초 정보 확인이 필요합니다`);
 1074:             break;
 1075:         case "family_urgent_transfer":
 1076:             pretextLines.push(`${callerTag}[가족] 긴급 상황입니다`);
 1077:             credLines.push(`지금 바로 확인이 필요합니다`);
 1078:             break;
 1079:         case "loan_fee":
 1080:             pretextLines.push(`${callerTag}${ORG} 심사 안내입니다`);
 1081:             credLines.push(`절차 진행을 위해 확인이 필요합니다`);
 1082:             break;
